<div class="container">

<table style="width: 100%;"><tr>
<td>apc.fit</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>
Fit an Age-Period-Cohort model to tabular data.
</h2>

<h3>Description</h3>

<p>Fits the classical five models to tabulated rate data (cases,
person-years) classified by two of age, period, cohort:
Age, Age-drift, Age-Period, Age-Cohort and Age-Period-Cohort. There are no
assumptions about the age, period or cohort classes being of the same
length, or that tabulation should be only by two of the variables.
Only requires that mean age and period for each tabulation unit is given.
</p>


<h3>Usage</h3>

<pre><code class="language-R">apc.fit( data,
            A,
            P,
            D,
            Y,
        ref.c,
        ref.p,
          dist = c("poisson","binomial"),
         model = c("ns","bs","ls","factor"),
       dr.extr = "Y",
          parm = c("ACP","APC","AdCP","AdPC","Ad-P-C","Ad-C-P","AC-P","AP-C"),
          npar = c( A=5, P=5, C=5 ),
         scale = 1,
         alpha = 0.05,
     print.AOV = TRUE )
  </code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>data</code></td>
<td>
<p>Data frame with (at least) variables, <code>A</code> (age),
<code>P</code> (period), <code>D</code> (cases, deaths) and <code>Y</code>
(person-years). Cohort (date of birth) is computed as <code>P-A</code>.
If this argument is given the arguments <code>A</code>, <code>P</code>,
<code>D</code> and <code>Y</code> are ignored.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>A</code></td>
<td>
<p>Age; numerical vector with mean age at diagnosis for each unit.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>P</code></td>
<td>
<p>Period; numerical vector with mean date of diagnosis for each
unit.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>D</code></td>
<td>
<p>Cases, deaths; numerical vector.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>Y</code></td>
<td>
<p>Person-years; numerical vector. Also used as denominator for binomial
data, see the <code>dist</code> argument.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ref.c</code></td>
<td>
<p>Reference cohort, numerical. Defaults to median date of
birth among cases. If used with <code>parm="AdCP"</code> or <code>parm="AdPC"</code>,
the residual cohort effects will be 1 at <code>ref.c</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ref.p</code></td>
<td>
<p>Reference period, numerical. Defaults to median date of
diagnosis among cases.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>dist</code></td>
<td>
<p>Distribution (or more precisely: Likelihood) used for modeling.
if a binomial model us used, <code>Y</code> is assumed to be the
denominator; <code>"binomial"</code> gives a binomial model with logit
link. The Age-effects returned are converted to the
probability scale, Period and Cohort effects are still odds-ratios.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>model</code></td>
<td>
<p>Type of model (covariate effects) fitted:
</p>

<ul>
<li> <p><code>ns</code> fits a model with natural splines for each of
the terms, with <code>npar</code> parameters for the terms.
</p>
</li>
<li> <p><code>bs</code> fits a model with B-splines for each of
the terms, with <code>npar</code> parameters for the terms.
</p>
</li>
<li> <p><code>ls</code> fits a model with linear splines.
</p>
</li>
<li> <p><code>factor</code> fits a factor model with one parameter
per value of <code>A</code>, <code>P</code> and <code>P-A</code>. <code>npar</code>
is ignored in this case. 
</p>
</li>
</ul>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>dr.extr</code></td>
<td>
<p>Character or numeric.	
How the drift parameter should be extracted from the
age-period-cohort model. Specifies the inner product used for
definition of orthogonality of the period / cohort effects to the
linear effects — in terms of a diagonal matrix.
</p>
<p><code>"Y"</code> (default) uses the no. person-time, <code>Y</code>,
corresponding to the observed information about the square root of
the rate.
</p>
<p><code>"R"</code> or <code>"L"</code> uses <code>Y*Y/D</code> corresponding to the
observed information about the rate (usually termed "lambda", hence
the "<code>L</code>"). 
</p>
<p><code>"D"</code> or <code>"T"</code> uses the no. events as the weight in the
inner product, corresponding to the information about the log-rate
(usually termed "theta", hence the "<code>T</code>").
</p>
<p>If given <code>"n"</code> (naive) (well, in fact any other character value) will
induce the use of the standard inner product putting equal weight on
all units in the dataset.
</p>
<p>If <code>dr.extr</code> is a numeric vector this is used as the diagonal
of the matrix inducing the inner product. 
</p>
<p>If <code>dr.extr</code> is a numeric scalar, <code>D + dr.extr*Y</code> is used
as the diagonal of the matrix inducing the inner product. This
family of inner products are the only ones that meet the
split-observation invariance criterion.
</p>
<p>The setting of this parameter has no effect on the fit of the model,
it only influences the parametrization returned in the <code>Age</code>,
<code>Per</code> and <code>Coh</code> elements of the resulting list.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>parm</code></td>
<td>
<p>Character. Indicates the parametrization of the effects.
The first four refer to the ML-fit of the Age-Period-Cohort model,
the last four give Age-effects from a smaller model and residuals
relative to this. If one of the latter is chosen, the argument
<code>dr.extr</code> is ignored. Possible values for <code>parm</code> are:
</p>

<ul>
<li> <p><code>"ACP"</code>: ML-estimates. Age-effects as rates for the
reference cohort. Cohort effects as RR relative to the reference
cohort. Period effects constrained to be 0 on average with 0 slope.
</p>
</li>
<li> <p><code>"APC"</code>: ML-estimates. Age-effects as rates for the
reference period. Period effects as RR relative to the reference
period. Cohort effects constrained to be 0 on average with 0 slope.
</p>
</li>
<li> <p><code>"AdCP"</code>: ML-estimates. Age-effects as rates for the
reference cohort. Cohort and period effects constrained to be 0 on
average with 0 slope. In this case returned effects do not
multiply to the fitted rates, the drift is missing and needs to be
included to produce the fitted values.
</p>
</li>
<li> <p><code>"AdPC"</code>: ML-estimates. Age-effects as rates for the
reference period. Cohort and period effects constrained to be 0 on
average with 0 slope. In this case returned effects do not
multiply to the fitted rates, the drift is missing and needs to be
included to produce the fitted values.
</p>
</li>
<li> <p><code>"Ad-C-P"</code>: Age effects are rates for the reference
cohort in the Age-drift model (cohort drift). Cohort effects are from the model
with cohort alone, using log(fitted values) from the Age-drift
model as offset. Period effects are from the model with period
alone using log(fitted values) from the cohort model as offset.
</p>
</li>
<li> <p><code>"Ad-P-C"</code>: Age effects are rates for the reference
period in the Age-drift model (period drift). Period effects are from the model
with period alone, using log(fitted values) from the Age-drift
model as offset. Cohort effects are from the model with cohort
alone using log(fitted values) from the period model as offset.
</p>
</li>
<li> <p><code>"AC-P"</code>: Age effects are rates for the reference
cohort in the Age-Cohort model, cohort effects are RR relative to
the reference cohort. Period effects are from the model
with period alone, using log(fitted values) from the Age-Cohort
model as offset.
</p>
</li>
<li> <p><code>"AP-C"</code>: Age effects are rates for the reference
period in the Age-Period model, period effects are RR relative to
the reference period. Cohort effects are from the model
with cohort alone, using log(fitted values) from the Age-Period
model as offset.
</p>
</li>
</ul>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>npar</code></td>
<td>
<p>The number of parameters/knots to use for each of the terms in
the model. If it is vector of length 3, the numbers are taken as the
no. of knots for Age, Period and Cohort, respectively. Unless it has
a names attribute with values "A", "P" and "C" in which case these
will be used. The knots chosen are the quantiles
<code>(1:nk-0.5)/nk</code> of the events (i.e. of <code>rep(A,D)</code> and
similarly for <code>P</code> and <code>C</code>).
</p>
<p><code>npar</code> may also be a named list of three numerical vectors with
names "A", "P" and "C", in which case these taken as the knots for
the age, period and cohort effect, the smallest and largest element in
each vector are used as the boundary knots.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>alpha</code></td>
<td>
<p>The significance level. Estimates are given with
(1-<code>alpha</code>) confidence limits.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>scale</code></td>
<td>
<p>numeric(1), factor multiplied to the rate estimates before output.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>print.AOV</code></td>
<td>
<p>Should the analysis of deviance table for the models
be printed?</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>Each record in the input data frame represents a subset of a Lexis
diagram. The subsets need not be of equal length on the age and
period axes, in fact there are no restrictions on the shape of
these; they could be Lexis triangles for example. The requirement is
that <code>A</code> and <code>P</code> are coded with the mean age and calendar
time of observation in the subset. This is essential since <code>A</code>
and <code>P</code> are used as quantitative variables in the models.
</p>
<p>This approach is different from to the vast majority of the uses of
APC-models in the literature where a factor model is used for age,
period and cohort effects. The latter can be obtained by using
<code>model="factor"</code>. Note however that the cohort factor is defined
from <code>A</code> and <code>P</code>, so that it is not possible in this
framework to replicate the Boyle-Robertson fallacy.
</p>


<h3>Value</h3>

<p>An object of class "apc" (recognized by <code>apc.plot</code> and
<code>apc.lines</code>) — a list with components:
</p>
<table>
<tr style="vertical-align: top;">
<td><code>Type</code></td>
<td>
<p>Text describing the model and parametrization returned.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>Model</code></td>
<td>
<p>The model object(s) on which the parametrization is based.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>Age</code></td>
<td>
<p>Matrix with 4 columns: <code>A.pt</code> with the ages (equals
<code>unique(A)</code>) and three columns giving the estimated rates with
c.i.s.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>Per</code></td>
<td>
<p>Matrix with 4 columns: <code>P.pt</code> with the dates of
diagnosis (equals <code>unique(P)</code>) and three columns giving the
estimated RRs with c.i.s.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>Coh</code></td>
<td>
<p>Matrix with 4 columns: <code>C.pt</code> with the dates of birth
(equals <code>unique(P-A)</code>) and three columns giving the estimated
RRs with c.i.s.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>Drift</code></td>
<td>
<p>A 3 column matrix with drift-estimates and c.i.s: The
first row is the ML-estimate of the drift (as defined by
<code>drift</code>), the second row is the estimate from the Age-drift
model. The first row name indicates which type of inner product were
used for projections. For the sequential parametrizations, only the
latter is given.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>Ref</code></td>
<td>
<p>Numerical vector of length 2 with reference period and cohort.
If ref.p or ref.c was not supplied the corresponding element is NA.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>Anova</code></td>
<td>
<p>Analysis of deviance table comparing the five classical
models.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>Knots</code></td>
<td>
<p>If <code>model</code> is one of <code>"ns"</code> or <code>"bs"</code>, a list
with three components: <code>Age</code>, <code>Per</code>, <code>Coh</code>, each one a
vector of knots. The max and the min of the vectors are the boundary knots.</p>
</td>
</tr>
</table>
<h3>Author(s)</h3>

<p>Bendix Carstensen, <a href="http://bendixcarstensen.com">http://bendixcarstensen.com</a>
</p>


<h3>References</h3>

<p>The considerations behind the parametrizations used in this function
are given in detail in:
B. Carstensen: Age-Period-Cohort models for the Lexis diagram.
Statistics in Medicine, 10; 26(15):3018-45, 2007.
</p>
<p>Various links to course material etc. is available through
<a href="http://bendixcarstensen.com/APC/">http://bendixcarstensen.com/APC/</a> 
</p>


<h3>See Also</h3>

<p><code>apc.frame</code>,
<code>apc.lines</code>,
<code>apc.plot</code>,
<code>LCa.fit</code>,
<code>apc.LCa</code>.
</p>


<h3>Examples</h3>

<pre><code class="language-R">library( Epi )
data(lungDK)

# Taylor a dataframe that meets the requirements for variable names
exd &lt;- lungDK[,c("Ax","Px","D","Y")]
names(exd)[1:2] &lt;- c("A","P")

# Three different ways of parametrizing the APC-model, ML
ex.1 &lt;- apc.fit( exd, npar=7, model="ns", dr.extr="1", parm="ACP", scale=10^5 )
ex.D &lt;- apc.fit( exd, npar=7, model="ns", dr.extr="D", parm="ACP", scale=10^5 )
ex.Y &lt;- apc.fit( exd, npar=7, model="ns", dr.extr="Y", parm="ACP", scale=10^5 )

# Sequential fit, first AC, then P given AC.
ex.S &lt;- apc.fit( exd, npar=7, model="ns", parm="AC-P", scale=10^5 )

# Show the estimated drifts
ex.1[["Drift"]]
ex.D[["Drift"]]
ex.Y[["Drift"]]
ex.S[["Drift"]]

# Plot the effects
lt &lt;- c("solid","22")[c(1,1,2)]
apc.plot( ex.1, lty=c(1,1,3) )
apc.lines( ex.D, col="red", lty=c(1,1,3) )
apc.lines( ex.Y, col="limegreen", lty=c(1,1,3) )
apc.lines( ex.S, col="blue", lty=c(1,1,3) )
</code></pre>


</div>