<div class="container">

<table style="width: 100%;"><tr>
<td>etm</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Computation of the empirical transition matrix</h2>

<h3>Description</h3>

<p>This function computes the empirical transition matrix, also called
Aalen-Johansen estimator, of the transition probability matrix of any
multistate model. The covariance matrix is also computed.
</p>


<h3>Usage</h3>

<pre><code class="language-R">## S3 method for class 'data.frame'
etm(data, state.names, tra, cens.name, s, t = "last",
    covariance = TRUE, delta.na = TRUE, modif = FALSE,
    c = 1, alpha = NULL, strata, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>data</code></td>
<td>
<p>data.frame of the form data.frame(id,from,to,time)
or (id,from,to,entry,exit)
</p>

<dl>
<dt>id:</dt>
<dd>
<p>patient id</p>
</dd>
<dt>from:</dt>
<dd>
<p>the state from where the transition occurs</p>
</dd>
<dt>to:</dt>
<dd>
<p>the state to which a transition occurs</p>
</dd>
<dt>time:</dt>
<dd>
<p>time when a transition occurs</p>
</dd>
<dt>entry:</dt>
<dd>
<p>entry time in a state</p>
</dd>
<dt>exit:</dt>
<dd>
<p>exit time from a state</p>
</dd>
</dl>
<p>This data.frame is transition-oriented, <em>i.e.</em> it contains one
row per transition, and possibly several rows per patient. Specifying
an entry and exit time permits to take into account left-truncation. </p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>state.names</code></td>
<td>
<p>A vector of characters giving the states names.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>tra</code></td>
<td>
<p>A quadratic matrix of logical values describing the possible
transitions within the multistate model. </p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>cens.name</code></td>
<td>
<p> A character giving the code for censored
observations in the column 'to' of <code>data</code>. If there is no
censored observations in your data, put 'NULL'.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>s</code></td>
<td>
<p>Starting value for computing the transition probabilities.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>t</code></td>
<td>
<p>Ending value. Default is "last", meaning that the transition
probabilities are computed over <code class="reqn">(s, t]</code>, <code class="reqn">t</code>
being the last time in the data set.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>covariance</code></td>
<td>
<p>Logical. Decide whether or not computing the
covariance matrix. May be useful for, say, simulations, as the variance
computation is a bit long. Default is TRUE.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>delta.na</code></td>
<td>
<p>Logical. Whether to export the array containing the
increments of the Nelson-Aalen estimator. Default is <code>TRUE</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>modif</code></td>
<td>
<p>Logical. Whether to apply the modification of Lai and
Ying for small risk sets</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>c</code></td>
<td>
<p>Constant for the Lai and Ying modification. Either <code>c</code>
contains only one value that will be used for all the states,
otherwise <code>c</code> should be the same length as
<code>state.names</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>alpha</code></td>
<td>
<p>Constant for the Lai and Ying modification. If NULL (the
default) then only <code>c</code> is used and the Lai and Ying
modification discards the event times for which <code class="reqn">Y(t) \geq
      t</code>. Otherwise <code class="reqn">cn^\alpha</code> is used. It is
recommanded to let <code>alpha</code> equal NULL for multistate models.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>strata</code></td>
<td>
<p>Character vector giving variables on which to stratify
the analysis.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>...</code></td>
<td>
<p>Not used</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>Data are considered to arise from a time-inhomogeneous Markovian
multistate model with finite state space, and possibly subject to
independent right-censoring and left-truncation.
</p>
<p>The matrix of the transition probabilities is estimated by the
Aalen-Johansen estimator / empirical transition matrix (Andersen et
al., 1993), which is the product integral over the time period
<code class="reqn">(s, t]</code> of I + the matrix of the increments of the
Nelson-Aalen estimates of the cumulative transition hazards. The
<code class="reqn">(i, j)-th</code> entry of the empirical transition matrix
estimates the transition probability of being in state <code class="reqn">j</code> at
time <code class="reqn">t</code> given that one has been in state j at time <code class="reqn">s</code>.
</p>
<p>The covariance matrix is computed using the recursion formula (4.4.19)
in Anderson et al. (1993, p. 295). This estimator of the covariance
matrix is an estimator of the Greenwood type.
</p>
<p>If the multistate model is not Markov, but censorship is entirely
random, the Aalen-Johansen estimator still consistently estimates the
state occupation probabilities of being in state <code class="reqn">i</code> at time
<code class="reqn">t</code> (Datta &amp; Satten, 2001; Glidden, 2002)
</p>
<p>Recent versions of R have changed the <code>data.frame</code> function,
where the default for the <code>stringsAsFactors</code>
argument from <code>TRUE</code> to <code>FALSE</code>. <code>etm</code> currently
depends on the states being factors, so that the user should use
<code>data.frame(..., stringsAsFactors=TRUE)</code>.
</p>


<h3>Value</h3>

<table>
<tr style="vertical-align: top;">
<td><code>est</code></td>
<td>
<p>Transition probability estimates. This is a 3 dimension
array with the first dimension being the state from where transitions
occur, the second the state to which transitions occur, and the
last one being the event times.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>cov</code></td>
<td>
<p>Estimated covariance matrix. Each cell of the matrix gives
the covariance between the transition probabilities given by the
rownames and the colnames, respectively.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>time</code></td>
<td>
<p>Event times at which the transition probabilities are
computed. That is all the observed times between <code class="reqn">(s, t]</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>s</code></td>
<td>
<p>Start of the time interval.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>t</code></td>
<td>
<p>End of the time interval.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>trans</code></td>
<td>
<p>A <code>data.frame</code> giving the possible transitions.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>state.names</code></td>
<td>
<p>A vector of character giving the state names.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>cens.name</code></td>
<td>
<p>How the censored observation are coded in the data
set.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>n.risk</code></td>
<td>
<p>Matrix indicating the number of individuals at risk just
before an event</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>n.event</code></td>
<td>
<p>Array containing the number of transitions at each
times</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>delta.na</code></td>
<td>
<p>A 3d array containing the increments of the
Nelson-Aalen estimator.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ind.n.risk</code></td>
<td>
<p>When <code>modif</code> is true, risk set size for which
the indicator function is 1</p>
</td>
</tr>
</table>
<p>If the analysis is stratified, a list of <code>etm</code> objects is
returned.
</p>


<h3>Note</h3>

<p>Transitions into a same state, mathematically superfluous, are not
allowed. If transitions into the same state are detected in the data,
the function will stop. Equally, <code>diag(tra)</code> must be set to
FALSE, see the example below.</p>


<h3>Author(s)</h3>

<p>Arthur Allignol, <a href="mailto:arthur.allignol@gmail.com">arthur.allignol@gmail.com</a></p>


<h3>References</h3>

<p>Beyersmann J, Allignol A, Schumacher M: Competing Risks and Multistate
Models with R (Use R!), Springer Verlag, 2012 (Use R!)
</p>
<p>Allignol, A., Schumacher, M. and Beyersmann, J. (2011).
Empirical Transition Matrix of Multi-State Models: The etm Package.
<em>Journal of Statistical Software</em>, 38.
</p>
<p>Andersen, P.K., Borgan, O., Gill, R.D. and Keiding,
N. (1993). <em>Statistical models based on counting
processes</em>. Springer Series in Statistics. New York, NY: Springer.
</p>
<p>Aalen, O. and Johansen, S. (1978). An empirical transition matrix for
non-homogeneous Markov chains based on censored
observations. <em>Scandinavian Journal of Statistics</em>, 5: 141-150.
</p>
<p>Gill, R.D. and Johansen, S. (1990). A survey of product-integration
with a view towards application in survival analysis. <em>Annals of
statistics</em>, 18(4): 1501-1555.
</p>
<p>Datta, S. and Satten G.A. (2001). Validity of the Aalen-Johansen
estimators of stage occupation probabilities and Nelson-Aalen
estimators of integrated transition hazards for non-Markov
models. <em>Statistics and Probability Letters</em>, 55(4): 403-411.
</p>
<p>Glidden, D. (2002). Robust inference for event probabilities with
non-Markov data. <em>Biometrics</em>, 58: 361-368.
</p>


<h3>See Also</h3>

<p><code>print.etm</code>, <code>summary.etm</code>, <code>sir.cont</code>,
<code>xyplot.etm</code></p>


<h3>Examples</h3>

<pre><code class="language-R">data(sir.cont)

# Modification for patients entering and leaving a state
# at the same date
# Change on ventilation status is considered
# to happen before end of hospital stay
sir.cont &lt;- sir.cont[order(sir.cont$id, sir.cont$time), ]
for (i in 2:nrow(sir.cont)) {
  if (sir.cont$id[i]==sir.cont$id[i-1]) {
    if (sir.cont$time[i]==sir.cont$time[i-1]) {
      sir.cont$time[i-1] &lt;- sir.cont$time[i-1] - 0.5
    }
  }
}

### Computation of the transition probabilities
# Possible transitions.
tra &lt;- matrix(ncol=3,nrow=3,FALSE)
tra[1, 2:3] &lt;- TRUE
tra[2, c(1, 3)] &lt;- TRUE

# etm
tr.prob &lt;- etm(sir.cont, c("0", "1", "2"), tra, "cens", 1)

tr.prob
summary(tr.prob)

# plotting
if (require("lattice")) {
xyplot(tr.prob, tr.choice=c("0 0", "1 1", "0 1", "0 2", "1 0", "1 2"),
       layout=c(2, 3), strip=strip.custom(bg="white",
         factor.levels=
     c("0 to 0", "1 to 1", "0 to 1", "0 to 2", "1 to 0", "1 to 2")))
}

### example with left-truncation

data(abortion)

# Data set modification in order to be used by etm
names(abortion) &lt;- c("id", "entry", "exit", "from", "to")
abortion$to &lt;- abortion$to + 1

## computation of the matrix giving the possible transitions
tra &lt;- matrix(FALSE, nrow = 5, ncol = 5)
tra[1:2, 3:5] &lt;- TRUE

## etm
fit &lt;- etm(abortion, as.character(0:4), tra, NULL, s = 0)

## plot
xyplot(fit, tr.choice = c("0 0", "1 1", "0 4", "1 4"),
       ci.fun = c("log-log", "log-log", "cloglog", "cloglog"),
       strip = strip.custom(factor.levels = c("P(T &gt; t) -- control",
                                              "P(T &gt; t) -- exposed",
                                 "CIF spontaneous abortion -- control",
                                 "CIF spontaneous abortion --
exposed")))
</code></pre>


</div>