<div class="container">

<table style="width: 100%;"><tr>
<td>ecospat.CCV.modeling</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>
Runs indivudual species distribuion models with SDMs or ESMs

</h2>

<h3>Description</h3>

<p>Creates probabilistic prediction for all species based on SDMs or ESMs and returns their evaluation metrics and variable importances.

</p>


<h3>Usage</h3>

<pre><code class="language-R">ecospat.CCV.modeling(sp.data, 
                     env.data, 
                     xy,
                     DataSplitTable=NULL,
                     DataSplit = 70, 
                     NbRunEval = 25,
                     minNbPredictors =5,
                     validation.method = "cross-validation",
                     models.sdm = c("GLM","RF"), 
                     models.esm = "CTA", 
                     modeling.options.sdm = NULL, 
                     modeling.options.esm = NULL, 
                     ensemble.metric = "AUC", 
                     ESM = "YES",
                     parallel = FALSE, 
                     cpus = 4,
                     VarImport = 10,
                     modeling.id)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>sp.data</code></td>
<td>
<p>a data.frame where the rows are sites and the columns are species (values 1,0)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>env.data</code></td>
<td>
<p>either a data.frame where rows are sites and colums are environmental variables or a SpatRaster of the envrionmental variables</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>xy</code></td>
<td>
<p>two column data.frame with X and Y coordinates of the sites (most be same coordinate system as <code>env.data</code>)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>DataSplitTable</code></td>
<td>
<p>a table providing <code>TRUE/FALSE</code> to indicate what points are used for calibration and evaluation. As returned by <code>ecospat.CCV.createDataSplitTable</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>DataSplit</code></td>
<td>
<p>percentage of dataset observations retained for the model training  (only needed if no <code>DataSplitTable</code> provided)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>NbRunEval</code></td>
<td>
<p>number of cross-validatio/split sample runs (only needed if no <code>DataSplitTable</code> provided)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>minNbPredictors</code></td>
<td>
<p>minimum number of occurences [min(presences/Absences] per predicotors needed to calibrate the models</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>validation.method</code></td>
<td>
<p>either "cross-validation" or "split-sample" used to validate the communtiy predictions (only needed if no <code>DataSplitTable</code> provided)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>models.sdm</code></td>
<td>
<p>modeling techniques used for the normal SDMs. Vector of models names choosen among <code>'GLM', 'GBM', 'GAM', 'CTA', 'ANN', 'SRE', 'FDA', 'MARS', 'RF', 'MAXENT' and 'MAXNET'</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>models.esm</code></td>
<td>
<p>modeling techniques used for the ESMs. Vector of models names choosen among <code>'GLM', 'GBM', 'GAM', 'CTA', 'ANN', 'SRE', 'FDA', 'MARS', 'RF', 'MAXENT' and 'MAXNET'</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>modeling.options.sdm</code></td>
<td>
<p>modeling options for the normal SDMs. <code>"BIOMOD.models.options"</code>" object returned by <code>bm_ModelingOptions</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>modeling.options.esm</code></td>
<td>
<p>modeling options for the ESMs. <code>"BIOMOD.models.options"</code> object returned by <code>bm_ModelingOptions</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ensemble.metric</code></td>
<td>
<p>evaluation score used to weight single models to build ensembles: <code>'AUC', 'Kappa' or 'TSS'</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ESM</code></td>
<td>
<p>either <code>'YES'</code> (ESMs allowed), <code>'NO'</code> (ESMs not allowed) or <code>'ALL'</code> (ESMs used in any case)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>parallel</code></td>
<td>
<p>should parallel computing be allowed (<code>TRUE/FALSE</code>)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>cpus</code></td>
<td>
<p>number of cpus to use in parallel computing</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>VarImport</code></td>
<td>
<p>number of permutation runs to evaluate variable importance</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>modeling.id</code></td>
<td>
<p>character, the ID (=name) of modeling procedure. A random number by default</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>The basic idea of the community cross-validation (CCV) is to use the same data (sites) for the model calibration/evaluation of all species. This ensures that there is "independent" cross-validation/split-sample data available not only at the individual species level but also at the community level. This is key to allow an unbiased estimation of the ability to predict species assemblages (Scherrer et al. 2018). 
The output of the ecospat.CCV.modeling function can then be used to evaluate the species assemblage predictions with the <code>ecospat.CCV.communityEvaluation.bin</code> or <code>ecospat.CCV.communityEvaluation.prob</code> functions.
</p>


<h3>Value</h3>

<table>
<tr style="vertical-align: top;">
<td><code>modelling.id</code></td>
<td>
<p>character, the ID (=name) of modeling procedure</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>output.files</code></td>
<td>
<p>vector with the names of the files written to the hard drive</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>speciesData.calibration</code></td>
<td>
<p>a 3-dimensional array of presence/absence data of all species for the calibration plots used for each run</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>speciesData.evaluation</code></td>
<td>
<p>a 3-dimensional array of presence/absence data of all species for the evaluation plots used for each run</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>speciesData.full</code></td>
<td>
<p>a data.frame of presence/absence data of all species (same as <code>sp.data</code> input)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>DataSplitTable</code></td>
<td>
<p>a matrix with <code>TRUE/FALSE</code> for each model run (<code>TRUE</code>=Calibration point, <code>FALSE</code>=Evaluation point)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>singleSpecies.ensembleEvaluationScore</code></td>
<td>
<p>a 3-dimensional array of single species evaluation metrics (<code>'Max.KAPPA', 'Max.TSS', 'AUC of ROC'</code>)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>singleSpecies.ensembleVariableImportance</code></td>
<td>
<p>a 3-dimensional array of single species variable importance for all predictors</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>singleSpecies.calibrationSites.ensemblePredictions</code></td>
<td>
<p>a 3-dimensional array of the predictions for each species and run at the calibration sites</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>singleSpecies.evaluationSites.ensemblePredictions</code></td>
<td>
<p>a 3-dimensional array of the predictions for each species and run at the evaluation sites</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>allSites.averagePredictions.cali</code></td>
<td>
<p>a matrix with the average predicted probabilities for each site across all the runs the sites were used for model calibration</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>allSites.averagePredictions.eval</code></td>
<td>
<p>a matrix with the average predicted probabilities for each site across all the runs the sites were used as independent evaluation sites</p>
</td>
</tr>
</table>
<h3>Author(s)</h3>

<p>Daniel Scherrer &lt;daniel.j.a.scherrer@gmail.com&gt; with the updates from Flavien Collart and Olivier Broennimann
</p>


<h3>References</h3>

<p>Scherrer, D., D'Amen, M., Mateo, M.R.G., Fernandes, R.F. &amp; Guisan , A. (2018) How to best threshold and validate stacked species assemblages? Community optimisation might hold the answer. Methods in Ecology and Evolution, in review
</p>


<h3>See Also</h3>

<p><code>ecospat.CCV.createDataSplitTable</code>; <code>ecospat.CCV.communityEvaluation.bin</code>; <code>ecospat.CCV.communityEvaluation.prob</code>
</p>


<h3>Examples</h3>

<pre><code class="language-R">
  #Loading species occurence data and remove empty communities
  data(ecospat.testData)
  testData &lt;- ecospat.testData[,c(24,34,43,45,48,53,55:58)]
  sp.data &lt;- testData[which(rowSums(testData)&gt;2), sort(colnames(testData))]
  
  #Loading environmental data
  env.data &lt;- ecospat.testData[which(rowSums(testData)&gt;2),4:8]
  
  #Coordinates for all sites
  xy &lt;- ecospat.testData[which(rowSums(testData)&gt;2),2:3]
  
  #Running all the models for all species
  myCCV.Models &lt;- ecospat.CCV.modeling(sp.data = sp.data,
                                       env.data = env.data,
                                       xy = xy,
                                       NbRunEval = 2,
                                       minNbPredictors = 10,
                                       VarImport = 3)
                                       
  #Calculating the probabilistic community metrics
  metrics = c('SR.deviation','community.AUC','probabilistic.Sorensen','Max.Sorensen')
  myCCV.Eval.prob &lt;- ecospat.CCV.communityEvaluation.prob(
          ccv.modeling.data = myCCV.Models, 
          community.metrics = metrics)
          
  #Thresholding all the predictions and calculating the community evaluation metrics
  myCCV.communityEvaluation.bin &lt;- ecospat.CCV.communityEvaluation.bin(
        ccv.modeling.data = myCCV.Models, 
        thresholds = c('MAX.KAPPA', 'MAX.ROC','PS_SDM'),
        community.metrics= c('SR.deviation','Sorensen'),
        parallel = FALSE,
        cpus = 4)
        
  #removing files on disk
  unlink(list.files(pattern=myCCV.Models$modeling.id))
  unlink(myCCV.Models$modeling.id,recursive=TRUE)
          

</code></pre>


</div>