<div class="container">

<table style="width: 100%;"><tr>
<td>q_gpd</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>GPD quantile of sample</h2>

<h3>Description</h3>

<p>Compute quantile of General Pareto Distribution fitted to sample by peak over threshold (POT) method
using threshold from truncation proportion,
comparing several R packages doing this
</p>


<h3>Usage</h3>

<pre><code class="language-R">q_gpd(
  x,
  probs = c(0.8, 0.9, 0.99),
  truncate = 0,
  threshold = berryFunctions::quantileMean(x, truncate),
  package = "extRemes",
  method = NULL,
  list = FALSE,
  undertruncNA = TRUE,
  quiet = FALSE,
  ttquiet = quiet,
  efquiet = quiet,
  ...
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>x</code></td>
<td>
<p>Vector with numeric values. NAs are silently ignored.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>probs</code></td>
<td>
<p>Probabilities of truncated (Peak over threshold) quantile.
DEFAULT: c(0.8,0.9,0.99)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>truncate</code></td>
<td>
<p>Truncation percentage (proportion of sample discarded). DEFAULT: 0</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>threshold</code></td>
<td>
<p>POT cutoff value. If you want correct percentiles, set this
only via truncate, see Details.
DEFAULT: <code>quantileMean(x, truncate)</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>package</code></td>
<td>
<p>Character string naming package to be used. One of
c("lmomco","evir","evd","extRemes","fExtremes","ismev").
DEFAULT: "extRemes"</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>method</code></td>
<td>
<p><code>method</code> passed to the fitting function, if applicable.
Defaults are internally specified (See Details), depending on
<code>package</code>, if left to the DEFAULT: NULL.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>list</code></td>
<td>
<p>Return result from the fitting function with the quantiles
added to the list as element <code>quant</code> and some information
in elements starting with <code>q_gpd_</code>. DEFAULT: FALSE</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>undertruncNA</code></td>
<td>
<p>Return NAs for probs below truncate? Highly recommended
to leave this at the DEFAULT: TRUE</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>quiet</code></td>
<td>
<p>Should messages from this function be suppressed? DEFAULT: FALSE</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ttquiet</code></td>
<td>
<p>Should truncation!=threshold messages from this function be
suppressed? DEFAULT: quiet</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>efquiet</code></td>
<td>
<p>Should warnings in function calls to the external packages be
suppressed via <code>options(warn=-1)</code>?
The usual type of warning is: NAs produced in log(...). DEFAULT: quiet</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>...</code></td>
<td>
<p>Further arguments passed to the fitting function listed in section Details.</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>Depending on the value of "package", this fits the GPD using <br><code>lmomco::pargpa</code><br><code>evir::gpd</code><br><code>evd::fpot</code><br><code>extRemes::fevd</code><br><code>fExtremes::gpdFit</code><br><code>ismev::gpd.fit</code><br><code>Renext::Renouv</code> or <code>Renext::fGPD</code><br><br></p>
<p>The <b><code>method</code></b> defaults (and other possibilities) are <br>
lmomco: none, only L-moments <br>
evir: "pwm" (probability-weighted moments), or "ml" (maximum likelihood) <br>
evd: none, only Maximum-likelihood fitting implemented <br>
extRemes: "MLE", or "GMLE", "Bayesian", "Lmoments" <br>
fExtremes: "pwm", or "mle"<br>
ismev: none, only Maximum-likelihood fitting implemented <br>
Renext: "r" for <code>Renouv</code> (since distname.y = "gpd", evd::fpot is used),
or 'f' for <code>fGPD</code> (with minimum POTs added)<br><br></p>
<p>The Quantiles are always given with <code>probs</code> in regard to the full (uncensored) sample.
If e.g. truncate is 0.90, the distribution function is fitted to the top 10% of the sample.
The 95th percentile of the full sample is equivalent to the 50% quantile of
the subsample actually used for fitting.
For computation, the probabilities are internally updated with <code>p2=(p-t)/(1-t)</code>
but labeled with the original <code>p</code>.
If you truncate 90% of the sample, you cannot compute the 70th percentile anymore,
thus <code>undertruncNA</code> should be left to TRUE. <br>
If not exported by the packages, the quantile functions are extracted from their source code (Nov 2016).
</p>


<h3>Value</h3>

<p>Named vector of quantile estimates for each value of <code>probs</code>,<br>
or if(list): list with element <code>q_gpd_quant</code> and info-elements added.
q_gpd_n_geq is number of values greater than or equal to q_gpd_threshold.
gt is only greater than.
</p>


<h3>Author(s)</h3>

<p>Berry Boessenkool, <a href="mailto:berry-b@gmx.de">berry-b@gmx.de</a>, Feb 2016
</p>


<h3>References</h3>

<p><a href="https://stackoverflow.com/q/27524131">https://stackoverflow.com/q/27524131</a>,
<a href="https://stats.stackexchange.com/q/129438">https://stats.stackexchange.com/q/129438</a>
</p>


<h3>See Also</h3>

<p><code>distLquantile</code> which compares results for all packages<br>
Other related packages (not implemented):<br><a href="https://cran.r-project.org/package=gPdtest">https://cran.r-project.org/package=gPdtest</a><br><a href="https://cran.r-project.org/package=actuar">https://cran.r-project.org/package=actuar</a><br><a href="https://cran.r-project.org/package=fitdistrplus">https://cran.r-project.org/package=fitdistrplus</a><br><a href="https://cran.r-project.org/package=lmom">https://cran.r-project.org/package=lmom</a><br></p>


<h3>Examples</h3>

<pre><code class="language-R">data(annMax)
q_gpd(annMax)
q_gpd(annMax, truncate=0.6)
q_gpd(annMax, truncate=0.85)
q_gpd(annMax, truncate=0.91)

q_gpd(annMax, package="evir")
q_gpd(annMax, package="evir", method="ml")
q_gpd(annMax, package="evd")
q_gpd(annMax, package="extRemes")
q_gpd(annMax, package="extRemes", method="GMLE")
#q_gpd(annMax, package="extRemes", method="Bayesian") # computes a while
q_gpd(annMax, package="extRemes", method="Lmoments")
q_gpd(annMax, package="extRemes", method="nonsense") # NAs
q_gpd(annMax, package="fExtremes")                   # log warnings
q_gpd(annMax, package="fExtremes", efquiet=TRUE)    # silenced warnings
q_gpd(annMax, package="fExtremes", method= "mle")
q_gpd(annMax, package="ismev")
q_gpd(annMax, package="Renext")
q_gpd(annMax, package="Renext", method="f")
berryFunctions::is.error(q_gpd(annMax, package="nonsense"), force=TRUE)

# compare all at once with
d &lt;- distLquantile(annMax); d
# d &lt;- distLquantile(annMax, speed=FALSE); d # for Bayesian also

q_gpd(annMax, truncate=0.85, package="evd")          # Note about quantiles
q_gpd(annMax, truncate=0.85, package="evir")
q_gpd(annMax, truncate=0.85, package="evir", quiet=TRUE) # No note
q_gpd(annMax, truncate=0.85, package="evir", undertruncNA=FALSE)

q_gpd(annMax, truncate=0.85, package="evir", list=TRUE)
str(  q_gpd(annMax, truncate=0.85, probs=0.6, package="evir", list=TRUE) )# NAs
str(  q_gpd(annMax, package="evir",      list=TRUE)   )
str(  q_gpd(annMax, package="evd",       list=TRUE)   )
str(  q_gpd(annMax, package="extRemes",  list=TRUE)   )
str(  q_gpd(annMax, package="fExtremes", list=TRUE)   )
str(  q_gpd(annMax, package="ismev",     list=TRUE)   )
str(  q_gpd(annMax, package="Renext",    list=TRUE)   )

q_gpd(annMax, package="evir", truncate=0.9, method="ml") # NAs (MLE fails often)

trunc &lt;- seq(0,0.9,len=500)
library("pbapply")
quant &lt;- pbsapply(trunc, function(tr) q_gpd(annMax, pack="evir", method = "pwm",
                                            truncate=tr, quiet=TRUE))
quant &lt;- pbsapply(trunc, function(tr) q_gpd(annMax, pack="lmomco", truncate=tr, quiet=TRUE))
plot(trunc, quant["99%",], type="l", ylim=c(80,130), las=1)
lines(trunc, quant["90%",])
lines(trunc, quant["80%",])
plot(trunc, quant["RMSE",], type="l", las=1)

## Not run: 
## Not run in checks because simulation takes too long

trunc &lt;- seq(0,0.9,len=200)
dlfs &lt;- pblapply(trunc, function(tr) distLfit(annMax, truncate=tr, quiet=TRUE, order=FALSE))
rmses &lt;- sapply(dlfs, function(x) x$gof$RMSE)
plot(trunc, trunc, type="n", ylim=range(rmses,na.rm=TRUE), las=1, ylab="rmse")
cols &lt;- rainbow2(17)[rank(rmses[,1])]
for(i in 1:17) lines(trunc, rmses[i,], col=cols[i])

dlfs2 &lt;- lapply(0:8/10, function(tr) distLfit(annMax, truncate=tr, quiet=TRUE))
pdf("dummy.pdf")
dummy &lt;- sapply(dlfs2, function(x)
{plotLfit(x, cdf=TRUE, main=x$truncate, ylim=0:1, xlim=c(20,135), nbest=1)
title(sub=round(x$gof$RMSE[1],4))
})
dev.off()

# truncation effect
mytruncs &lt;- seq(0, 0.9, len=150)
oo &lt;- options(show.error.messages=FALSE, warn=-1)
myquants &lt;- sapply(mytruncs, function(t) q_gpd(annMax, truncate=t, quiet=TRUE))
options(oo)
plot(1, type="n", ylim=range(myquants, na.rm=TRUE), xlim=c(0,0.9), las=1,
     xlab="truncated proportion", ylab="estimated quantiles")
abline(h=quantileMean(annMax, probs=c(0.8,0.9,0.99)))
for(i in 1:3) lines(mytruncs, myquants[i,], col=i)
text(0.3, c(87,97,116), rownames(myquants), col=1:3)


# Underestimation in small samples
# create known population:
dat &lt;- extRemes::revd(1e5, scale=50, shape=-0.02, threshold=30, type="GP")
op &lt;- par(mfrow=c(1,2), mar=c(2,2,1,1))
hist(dat, breaks=50, col="tan")
berryFunctions::logHist(dat, breaks=50, col="tan")
par(op)

# function to estimate empirical and GPD quantiles from subsamples
samsizeeffect &lt;- function(n, nrep=30, probs=0.999, trunc=0.5, Q=c(0.4,0.5,0.6))
{
res &lt;- replicate(nrep, {
subsample &lt;- sample(dat, n)
qGPD &lt;- q_gpd(subsample, probs=probs, truncate=trunc)
qEMP &lt;- berryFunctions::quantileMean(subsample, probs=probs, truncate=trunc)
c(qGPD=qGPD, qEMP=qEMP)})
apply(res, MARGIN=1, berryFunctions::quantileMean, probs=Q)
}

# Run and plot simulations
samplesize &lt;- c(seq(20, 150, 10), seq(200,800, 100))
results &lt;- pbapply::pblapply(samplesize, samsizeeffect)
res &lt;- function(row, col) sapply(results, function(x) x[row,col])
berryFunctions::ciBand(yu=res(3,1),yl=res(1,1),ym=res(2,1),x=samplesize,
  main="99.9% Quantile underestimation", xlab="subsample size", ylim=c(200,400), colm=4)
berryFunctions::ciBand(yu=res(3,2),yl=res(1,2),ym=res(2,2),x=samplesize, add=TRUE)
abline(h=berryFunctions::quantileMean(dat, probs=0.999))
text(300, 360, "empirical quantile of full sample")
text(300, 340, "GPD parametric estimate", col=4)
text(300, 300, "empirical quantile estimate", col="green3")


## End(Not run) # end of dontrun

</code></pre>


</div>