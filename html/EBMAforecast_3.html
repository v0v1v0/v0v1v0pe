<div class="container">

<table style="width: 100%;"><tr>
<td>calibrateEnsemble</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Calibrate an ensemble Bayesian Model Averaging model</h2>

<h3>Description</h3>

<p>This function calibrates an EBMA model based on out-of-sample performance in the calibration period. Given a dependent variable and calibration-sample predictions from multiple component forecast models in the <code>ForecastData</code>, the <code>calibrateEnsemble</code> function fits an ensemble BMA mixture model. The weights assigned to each model are derived from the individual model's performance in the calibration period. Missing observations are allowed in the calibration period, however models with missing observations are penalized. When missing observations are prevalent in the calibration set, the EM algorithm or gibbs sampler is adjusted and model paprameters are estimated by maximizing a renormalized partial expected complete-data log-likelihood (Fraley et al. 2010).
</p>


<h3>Usage</h3>

<pre><code class="language-R">calibrateEnsemble(
  .forecastData = new("ForecastData"),
  exp = 1,
  tol = sqrt(.Machine$double.eps),
  maxIter = 1e+06,
  model = "logit",
  method = "EM",
  predType = "posteriorMedian",
  useModelParams = TRUE,
  W = rep(1/dim(.forecastData@predCalibration)[2], dim(.forecastData@predCalibration)[2]),
  const = 0,
  modelPriors = rep(1, dim(.forecastData@predCalibration)[2]),
  iterations = 40000,
  burns = 20000,
  thinning = 20,
  ...
)

## S4 method for signature 'ForecastData'
calibrateEnsemble(
  .forecastData = new("ForecastData"),
  exp = 1,
  tol = sqrt(.Machine$double.eps),
  maxIter = 1e+06,
  model = "logit",
  method = "EM",
  predType = "posteriorMean",
  useModelParams = TRUE,
  W = rep(1/dim(.forecastData@predCalibration)[2], dim(.forecastData@predCalibration)[2]),
  const = 0,
  modelPriors = rep(1, dim(.forecastData@predCalibration)[2]),
  iterations = 40000,
  burns = 20000,
  thinning = 20,
  ...
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>.forecastData</code></td>
<td>
<p>An object of class 'ForecastData' that will be used to calibrate the model.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>exp</code></td>
<td>
<p>The exponential shrinkage term.  Forecasts are raised to the (1/exp) power on the logit scale for the purposes of bias reduction.  The default value is <code>exp=3</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>tol</code></td>
<td>
<p>Tolerance for improvements in the log-likelihood before the EM algorithm will stop optimization.  The default is <code>tol= 0.01</code>, which is somewhat high.  Researchers may wish to reduce this by an order of magnitude for final model estimation.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>maxIter</code></td>
<td>
<p>The maximum number of iterations the EM algorithm will run before stopping automatically. The default is <code>maxIter=10000</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>model</code></td>
<td>
<p>The model type that should be used given the type of data that is being predicted (i.e., normal, binary, etc.).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>method</code></td>
<td>
<p>The estimation method used. It takes either an <code>EM</code> or <code>gibbs</code> as an argument.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>predType</code></td>
<td>
<p>The prediction type used for the gibbs sampling EBMA model, user can choose either <code>posteriorMedian</code> or <code>posteriorMean</code> (default). Model performance statistics are based on the posterior median or mean forecast. Note that the posterior median forecast is not equal to the forecast based on the median posterior weight. EM predictions based on mean.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>useModelParams</code></td>
<td>
<p>If "TRUE" individual model predictions are transformed based on logit models. If "FALSE" all models' parameters will be set to 0 and 1.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>W</code></td>
<td>
<p>A vector or matrix of initial model weights. If unspecified, each model will receive weight equal to 1/number of Models</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>const</code></td>
<td>
<p>User provided "wisdom of crowds" parameter, serves as minimum model weight for all models. Default = 0. Only used in model estimated using EM.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>modelPriors</code></td>
<td>
<p>User provided vector of Dirichlet prior for each of the models. Only used in normal model estimated with gibbs sampling. Default prior is 1 for each model.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>iterations</code></td>
<td>
<p>The number of iterations for the Bayesian model. Default = 40000.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>burns</code></td>
<td>
<p>The burn in for the Gibbs sampler. Default = 20000.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>thinning</code></td>
<td>
<p>How much the Gibbs sampler is thinned. Default = 20.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>...</code></td>
<td>
<p>Not implemented</p>
</td>
</tr>
</table>
<h3>Value</h3>

<p>Returns a data of class 'FDatFitLogit' or FDatFitNormal, a subclass of 'ForecastData', with the following slots
</p>
<table>
<tr style="vertical-align: top;">
<td><code>predCalibration</code></td>
<td>
<p>A matrix containing the predictions of all component models and the EBMA model for all observations in the calibration period. Under gibbs sampling, the EBMA prediction is either the median or mean of the posterior predictive distribution, depending on the <code>predType</code> setting.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>predTest</code></td>
<td>
<p>A matrix containing the predictions of all component models and the EBMA model for all observations in the test period. Under gibbs sampling, the EBMA prediction is either the median or mean of the posterior predictive distribution, depending on the <code>predType</code> setting.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>outcomeCalibration</code></td>
<td>
<p>A vector containing the true values of the dependent variable for all observations in the calibration period.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>outcomeTest</code></td>
<td>
<p>An optional vector containing the true values of the dependent variable for all observations in the test period.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>modelNames</code></td>
<td>
<p>A character vector containing the names of all component models.  If no model names are specified, names will be assigned automatically.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>modelWeights</code></td>
<td>
<p>A vector containing model weights assigned to each model. When the gibbs sampler is used, this slot contains either the median or mean of the posterior weights, depending on the <code>predType</code> setting.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>modelParams</code></td>
<td>
<p>The parameters for the individual logit models that transform the component models.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>useModelParams</code></td>
<td>
<p>Indicator whether model parameters for transformation were estimated or not.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>logLik</code></td>
<td>
<p>The final log-likelihood for the calibrated EBMA model. Empty for estimations using the gibbs sampler.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>exp</code></td>
<td>
<p>The exponential shrinkage term.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>tol</code></td>
<td>
<p>Tolerance for improvements in the log-likelihood before the EM algorithm will stop optimization.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>maxIter</code></td>
<td>
<p>The maximum number of iterations the EM algorithm will run before stopping automatically.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>method</code></td>
<td>
<p>The estimation method used. </p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>iter</code></td>
<td>
<p>Number of iterations run in the EM algorithm. Empty for estimations using the gibbs sampler.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>call</code></td>
<td>
<p>The actual call used to create the object.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>posteriorWeights</code></td>
<td>
<p>A matrix of the full posterior model weights from model calibration. Rows are the observations in the calibration period, columns are the saved iterations of the gibbs sampler. Empty for EM estimations.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>posteriorPredCalibration</code></td>
<td>
<p>A matrix of the posterior predictive distribution for observations in the calibration period, based on the full posterior of model weights. Empty for EM estimations.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>posteriorPredTest</code></td>
<td>
<p>A matrix of the posterior predictive distribution for observations in the test period, based on the full posterior of model weights. Empty for EM estimations.</p>
</td>
</tr>
</table>
<h3>Author(s)</h3>

<p>Michael D. Ward &lt;<a href="mailto:michael.d.ward@duke.edu">michael.d.ward@duke.edu</a>&gt; and Jacob M. Montgomery &lt;<a href="mailto:jacob.montgomery@wustl.edu">jacob.montgomery@wustl.edu</a>&gt; and Florian M. Hollenbach &lt;<a href="mailto:florian.hollenbach@tamu.edu">florian.hollenbach@tamu.edu</a>&gt;
</p>


<h3>References</h3>

<p>Montgomery, Jacob M., Florian M. Hollenbach and Michael D. Ward. (2012). Improving Predictions Using Ensemble Bayesian Model Averaging. <em>Political Analysis</em>. <b>20</b>: 271-291.
</p>
<p>Raftery, A. E., T. Gneiting, F. Balabdaoui and M. Polakowski. (2005). Using Bayesian Model Averaging to calibrate forecast ensembles. <em>Monthly Weather Review</em>. <b>133</b>:1155–1174.
</p>
<p>Sloughter, J. M., A. E. Raftery, T. Gneiting and C. Fraley. (2007). Probabilistic quantitative precipitation forecasting using Bayesian model averaging. <em>Monthly Weather Review</em>. <b>135</b>:3209–3220.
</p>
<p>Fraley, C., A. E. Raftery, T. Gneiting. (2010). Calibrating Multi-Model Forecast Ensembles with Exchangeable and Missing Members using Bayesian Model Averaging. <em>Monthly Weather Review</em>. <b>138</b>:190–202.
</p>
<p>Sloughter, J. M., T. Gneiting and A. E. Raftery. (2010). Probabilistic wind speed forecasting using ensembles and Bayesian model averaging. <em>Journal of the American Statistical Association</em>. <b>105</b>:25–35.
</p>
<p>Fraley, C., A. E. Raftery, and T. Gneiting. (2010). Calibrating multimodel forecast ensembles with exchangeable and missing members using Bayesian model averaging. <em>Monthly Weather Review</em>. <b>138</b>:190–202.
</p>


<h3>Examples</h3>

<pre><code class="language-R">## Not run: 
data(calibrationSample)

data(testSample)

this.ForecastData &lt;- makeForecastData(.predCalibration=calibrationSample[,c("LMER", "SAE", "GLM")],
.outcomeCalibration=calibrationSample[,"Insurgency"],.predTest=testSample[,c("LMER", "SAE", "GLM")],
.outcomeTest=testSample[,"Insurgency"], .modelNames=c("LMER", "SAE", "GLM"))
initW &lt;- rep(1/3,3)

this.ensemble.em &lt;- calibrateEnsemble(this.ForecastData, model="logit", tol=0.001)

this.ensemble.gibbs &lt;- calibrateEnsemble(this.ForecastData, model="logit", method = "gibbs")

## End(Not run)

</code></pre>


</div>