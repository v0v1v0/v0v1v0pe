<div class="container">

<table style="width: 100%;"><tr>
<td>calibrate</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Fit a Calibration Line or Curve</h2>

<h3>Description</h3>

<p>Fit a calibration line or curve based on linear regression.
</p>


<h3>Usage</h3>

<pre><code class="language-R">  calibrate(formula, data, test.higher.orders = TRUE, max.order = 4, p.crit = 0.05,
    F.test = "partial", weights, subset, na.action, method = "qr", model = FALSE,
    x = FALSE, y = FALSE, contrasts = NULL, warn = TRUE, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>formula</code></td>
<td>

<p>a <code>formula</code> object, with the response on the left of a <code>~</code> operator, and
the single predictor variable on the right.  For example, <code>Cadmium ~ Spike</code>.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>data</code></td>
<td>

<p>an optional data frame, list or environment (or object coercible by <br><code>as.data.frame</code> to a data frame) containing the variables in
the model.  If not found in <code>data</code>, the variables are taken from
<code>environment(formula)</code>, typically the environment from which
<code>calibrate</code> is called.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>test.higher.orders</code></td>
<td>

<p>logical scalar indicating whether to start with a model that contains a single predictor
variable and test the fit of higher order polynomials to consider for the calibration
curve (<code>test.higher.orders=TRUE</code>; the default), or to simply use the model suppled
and add the model matrix to the fit if it was not already indicated by the argument
<code>x=TRUE</code> in the call to <code>calibrate</code>.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>max.order</code></td>
<td>

<p>integer indicating the maximum order of the polynomial to consider for the
calibration curve.  The default value is <code>max.order=4</code>, however, the final value of
<code>max.order</code> is the minimum of <code>max.order</code> and value of the number of
unique predictor values minus 1.  So, for example, if there are only 4 unique values of
the single predictor variable, then the final value of <code>max.order</code> is the minimum of
what the user supplies and 3; thus, in this case, the highest order polynomial that will
be potentially tested is a cubic.  See also the explanation below for the argument
<code>warn</code>.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>p.crit</code></td>
<td>

<p>numeric scaler between 0 and 1 indicating the p-value to use for the stepwise regression
when determining which polynomial model to use.  The default value is <code>p.crit=0.05</code>.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>F.test</code></td>
<td>

<p>character string indicating whether to perform the stepwise regression using the
standard partial F-test (<code>F.test="partial"</code>; the default) or using the
lack-of-fit F-test (<code>F.test="lof"</code>).
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>weights</code></td>
<td>

<p>optional vector of observation weights; if supplied, the algorithm fits to minimize the sum of the
weights multiplied into the squared residuals.  The length of weights must be the same as
the number of observations.  The weights must be nonnegative and it is strongly recommended
that they be strictly positive, since zero weights are ambiguous, compared to use of the
<code>subset</code> argument.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>subset</code></td>
<td>

<p>optional expression saying which subset of the rows of the data should be used in the fit.
This can be a logical vector (which is replicated to have length equal to the number of
observations), or a numeric vector indicating which observation numbers are to be included,
or a character vector of the row names to be included.  All observations are included by
default.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>na.action</code></td>
<td>

<p>optional function which indicates what should happen when the data contain <code>NAs</code>.
The default is set by the <code>na.action</code> setting of <code>options</code>, and is <br><code>na.fail</code> if that is unset.  The ‘factory-fresh’ default is
<code>na.omit</code>.  Another possible value is <code>NULL</code>, no action.
Value <code>na.exclude</code> can be useful.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>method</code></td>
<td>

<p>optional method to be used; for fitting, currently only <code>method = "qr"</code> is supported;
<code>method = "model.frame"</code> returns the model frame (the same as with
<code>model = TRUE</code>, see below).
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>model, x, y, qr</code></td>
<td>

<p>optional logicals. If <code>TRUE</code> the corresponding components of the fit (the model frame,
the model matrix, the response, the QR decomposition) are returned.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>contrasts</code></td>
<td>

<p>an optional list. See the argument <code>contrasts.arg</code> of <code>model.matrix</code>.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>warn</code></td>
<td>

<p>logical scalar indicating whether to issue a warning (<code>warn=TRUE</code>; the default) when
the value of <code>max.order</code> has been decreased from what the user supplied.
See also the explanation above for the argument <code>max.order</code>.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>...</code></td>
<td>

<p>additional arguments to be passed to the low level regression fitting functions
(see <code>lm</code>).
</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>A simple and frequently used calibration model is a straight line where the response variable
<em>S</em> denotes the signal of the machine and the predictor variable <em>C</em> denotes the
true concentration in the physical sample.  The error term is assumed to follow a normal distribution
with mean 0.  Note that the average value of the signal for a blank (<em>C</em> = 0) is the intercept.
Other possible calibration models include higher order polynomial models such as a quadratic or
cubic model.
</p>
<p>In a typical setup, a small number of samples (e.g., n = 6) with known concentrations are measured
and the signal is recorded.  A sample with no chemical in it, called a blank, is also measured.
(You have to be careful to define exactly what you mean by a “blank.”  A blank could mean
a container from the lab that has nothing in it but is prepared in a similar fashion to containers
with actual samples in them.  Or it could mean a field blank: the container was taken out to the
field and subjected to the same process that all other containers were subjected to, except a physical
sample of soil or water was not placed in the container.)  Usually, replicate measures at the same
known concentrations are taken.  (The term “replicate” must be well defined to distinguish
between for example the same physical samples that are measured more than once vs. two different
physical samples of the same known concentration.)
</p>
<p>The function <code>calibrate</code> initially fits a linear calibration model.  If the argument
<code>max.order</code> is greater than 1, <code>calibrate</code> then performs forward stepwise linear
regression to determine the “best” polynomial model.
</p>
<p>In the case where replicates are not availble, <code>calibrate</code> uses standard stepwise
ANOVA to compare models (Draper and Smith, 1998, p.335). In this case, if the p-value
for the partial F-test to compare models is greater than or equal to <code>p.crit</code>, then
the model with fewer terms is used as the final model.
</p>
<p>In the case where replicates are available, if <code>F.test="lof"</code>, then for each model
<code>calibrate</code> computes the p-value of the ANOVA for lack-of-fit vs. pure error
(Draper and Smith, 1998, Chapters 2; see <code>anovaPE</code>).  If the p-value is
greater than or equal to <code>p.crit</code>, then this is the final model; otherwise the next
higher-order term is added to the polynomial and the model is re-fit.  If, during the
stepwise procedure, the degrees of freedom associated with the residual sums of squares
of a model to be tested is less than or equal to the number of observations minus the
number of unique observations, <code>calibrate</code> uses the partial F-test instead of the
lack-of-fit F-test.
</p>
<p>The stepwise algorithm terminates when either the p-value is greater than or equal to
<code>p.crit</code>, or the currently selected model in the algorithm is of order
<code>max.order</code>.  The algorithm will terminate earlier than this if the next model to be
fit includes singularities so that not all coefficients can be estimted.
</p>


<h3>Value</h3>

<p>An object of <code>class</code> <code>"calibrate"</code> that inherits from
<code>class</code> <code>"lm"</code> and includes a component called
<code>x</code> that stores the model matrix (the values of the predictor variables for the final
calibration model).
</p>


<h3>Note</h3>

<p>Almost always the process of determining the concentration of a chemical in a soil,
water, or air sample involves using some kind of machine that produces a signal, and
this signal is related to the concentration of the chemical in the physical sample.
The process of relating the machine signal to the concentration of the chemical is
called <strong>calibration</strong>.  Once calibration has been performed, estimated
concentrations in physical samples with unknown concentrations are computed using
inverse regression (see <code>inversePredictCalibrate</code>).  The uncertainty
in the process used to estimate the concentration may be quantified with decision,
detection, and quantitation limits.
</p>


<h3>Author(s)</h3>

<p>Steven P. Millard (<a href="mailto:EnvStats@ProbStatInfo.com">EnvStats@ProbStatInfo.com</a>)
</p>


<h3>References</h3>

<p>Draper, N., and H. Smith. (1998). <em>Applied Regression Analysis</em>. Third Edition.
John Wiley and Sons, New York, Chapter 3 and p.335.
</p>
<p>Gibbons, R.D., D.K. Bhaumik, and S. Aryal. (2009).
<em>Statistical Methods for Groundwater Monitoring</em>. Second Edition.
John Wiley &amp; Sons, Hoboken.  Chapter 6, p. 111.
</p>
<p>Helsel, D.R. (2012). <em>Statistics for Censored Environmental Data Using Minitab and R,
Second Edition</em>.  John Wiley &amp; Sons, Hoboken, New Jersey.  Chapter 3, p. 22.
</p>
<p>Millard, S.P., and N.K. Neerchal. (2001). <em>Environmental Statistics with S-PLUS</em>.
CRC Press, Boca Raton, FL, pp.562-575.
</p>


<h3>See Also</h3>

<p><code>calibrate.object</code>, <code>anovaPE</code>,
<code>inversePredictCalibrate</code>,
<code>detectionLimitCalibrate</code>, <code>lm</code>.
</p>


<h3>Examples</h3>

<pre><code class="language-R">  # The data frame EPA.97.cadmium.111.df contains calibration data for
  # cadmium at mass 111 (ng/L) that appeared in Gibbons et al. (1997b)
  # and were provided to them by the U.S. EPA.
  # Display a plot of these data along with the fitted calibration line
  # and 99% non-simultaneous prediction limits.  See
  # Millard and Neerchal (2001, pp.566-569) for more details on this
  # example.

  Cadmium &lt;- EPA.97.cadmium.111.df$Cadmium

  Spike &lt;- EPA.97.cadmium.111.df$Spike

  calibrate.list &lt;- calibrate(Cadmium ~ Spike, data = EPA.97.cadmium.111.df)

  newdata &lt;- data.frame(Spike = seq(min(Spike), max(Spike), len = 100))

  pred.list &lt;- predict(calibrate.list, newdata = newdata, se.fit = TRUE)

  pointwise.list &lt;- pointwise(pred.list, coverage = 0.99, individual = TRUE)

  dev.new()
  plot(Spike, Cadmium, ylim = c(min(pointwise.list$lower),
    max(pointwise.list$upper)), xlab = "True Concentration (ng/L)",
    ylab = "Observed Concentration (ng/L)")

  abline(calibrate.list, lwd = 2)

  lines(newdata$Spike, pointwise.list$lower, lty = 8, lwd = 2)

  lines(newdata$Spike, pointwise.list$upper, lty = 8, lwd = 2)

  title(paste("Calibration Line and 99% Prediction Limits",
    "for US EPA Cadmium 111 Data", sep = "\n"))

  #----------

  # Clean up
  #---------
  rm(Cadmium, Spike, newdata, calibrate.list, pred.list, pointwise.list)
  graphics.off()
</code></pre>


</div>