<div class="container">

<table style="width: 100%;"><tr>
<td>explanation</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Explanation of predictions on instance and model level</h2>

<h3>Description</h3>

<p>Using general explanation methodology EXPLAIN or IME, the function <code>explainVis</code> explains
predictions of given model and visualizes the  explanations.
An explanation of a prediction is given for individual instances; aggregation of instance explanations 
gives a model explanation. The details are given in the description and references.
</p>


<h3>Usage</h3>

<pre><code class="language-R">explainVis(model, trainData, testData,  
   method=c("EXPLAIN", "IME"), classValue=1,
   fileType=c("none","pdf","eps","emf","jpg","png","bmp","tif","tiff"), 
   dirName=getwd(), fileName="explainVis", visLevel=c("both","model","instance"),
   explainType=c("WE","infGain","predDiff"), naMode=c("avg", "na"), 
   nLaplace=nrow(trainData), estimator=NULL,	
   pError=0.05, err=0.05, batchSize=40, maxIter=1000, 
   genType=c("rf", "rbf", "indAttr"), noAvgBins=20, 
   displayAttributes=NULL, modelVisCompact=FALSE, 
   displayThreshold=0.0, normalizeTo=0, 
   colors=c("navyblue", "darkred", "blue", "red", "lightblue", "orange"), 
   noDecimalsInValueName=2,
   modelTitle=ifelse(model$noClasses==0,"Explaining %R\nmodel: %M", 
      "Explaining %R=%V\nmodel: %M"), 
   modelSubtitle="Method: %E, type: %X", 
   instanceTitle=ifelse(model$noClasses==0, 
      "Explaining %R\ninstance: %I, model: %M",
      "Explaining %R=%V\ninstance: %I, model: %M"), 
   instanceSubtitle=ifelse(model$noClasses==0, 
	  "Method: %E\nf(%I)=%P, true %R=%T",
      "Method: %E, type: %X\nP(%R=%V)=%P, true %R=%T"),
   recall=NULL) 		                                    
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>model</code></td>
<td>
<p> The model as returned by <code>CoreModel</code> function. </p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>trainData</code></td>
<td>
<p> Data frame with data, which is used to extract average explanations, discretization, 
and other information needed for explanation of instances and model. Typically this is the data set 
which was used to train the <code>model</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>testData</code></td>
<td>
<p> Data frame with instances which will be explained. 
The <code>testData</code> data frame shall contain the same columns as <code>trainData</code>, with possible exception
of target variable, which can be omitted.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>method</code></td>
<td>
<p> The explanation method; two methods are available, EXPLAIN and IME. The EXPLAIN is much faster 
and works for any number of attributes in the model,
but cannot explain dependencies expressed disjunctively in the model (for details see references). 
The IME can in principle explain any type of dependencies
in the model. It uses sampling based method to avoid exhaustive search for dependencies and 
works reasonably fast for up to a few dozen attributes in the model.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>classValue</code></td>
<td>
<p> For classification models this parameter determines for which class value the explanations will be generated.
The <code>classValue</code> can be given as a factor, character string or class index. 
By default the first class value is chosen.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>fileType</code></td>
<td>
<p>The parameter determines the graphical format of the visualization file(s). 
If <code>fileType="none"</code> (default) visualizations are generated in a
graphical window. Other possible choices are <code>"pdf","eps","emf","jpg","png","bmp","tif"</code> and <code>"tiff"</code>. </p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>dirName</code></td>
<td>
<p> A name of the folder where resulting visualization files will be saved if <code>fileType</code> other than <code>"none"</code> is chosen.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>fileName</code></td>
<td>
<p> A file name of the resulting visualization files, in case <code>fileType</code> other than <code>"none"</code> is chosen.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>visLevel</code></td>
<td>
<p> The level of explanations desired. If <code>visLevel="model"</code> the model explanation is 
generated, meaning that instance explanations obtained on <code>trainData</code> are aggregated. 
If <code>visLevel="instance"</code>  instance explanations are generated  for each row in testData. 
The default value <code>visLevel="both"</code> generates both, the model explanation and explanations for the instances.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>explainType</code></td>
<td>
<p>For method EXPLAIN this parameter determines how the prediction with knowledge about 
given feature and prediction
without knowledge of this feature are combined into the final explanation. 
Values <code>"WE"</code>, <code>"infGain"</code>, and <code>"predDiff"</code> mean that the difference
is interpreted as weight of evidence, information gain, or plain difference, respectively.
For regression problem only the difference of predictions is available.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>naMode</code></td>
<td>
<p>For method EXPLAIN this parameter determines how the impact of missing information about certain feature value is
estimated. If <code>naMode="avg"</code>, the effect is estimated by the weighted average of predictions 
over all possible feature's values.
If <code>naMode="na"</code>, the effect is estimated by inserting NA value as feature value. 
The <code>"na"</code> method is faster but we are 
left to the mercy of adequate treatment of missing values in the function <code>predict</code> for a given model. </p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>nLaplace</code></td>
<td>
<p> For EXPLAIN method and classification problems the predicted probabilities are corrected with Laplace correction,
pushing them away from 0 and 1 and towards uniform distribution. Larger values imply smaller effect. The default value is equal
to the number of instances in <code>trainData</code>. The value 0 means that Laplace correction is not used and probabilities
are estimated with relative frequency.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>estimator</code></td>
<td>
<p> The name of feature evaluation method used to greedily discretize attributes 
when averaging explanation over intervals.
The default value <code>NULL</code> means that <code>"ReliefFexpRank"</code> will be used in classification problems and 
<code>"RReliefFexpRank"</code> will be used in regression problems. See <code>discretize</code> for details.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>pError</code></td>
<td>
<p>For method IME the estimated probability of an error in explanations. Together with
parameter <code>err</code> this determines the number of needed samples.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>err</code></td>
<td>
<p>For method IME the parameter controls the size of tolerable error. 
Together with parameter <code>pError</code> this determines the number of needed samples. 
See the paper <em>An Efficient Explanation of Individual Classifications using Game Theory</em> for details.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>batchSize</code></td>
<td>
<p>For method IME the number of samples processed in batch mode for each explanation. Larger sizes cause
less overhead in processing but may process more samples than required.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>maxIter</code></td>
<td>
<p>The maximal number of iterations in IME method allowed for a single explanation.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>genType</code></td>
<td>
<p>The type of data generator used to generate random part of instances in method IME. 
The generators from package <code>semiArtificial-package</code> are used: 
<code>"rf"</code> stands for random forest based generator, 
<code>"rbf"</code> invokes RBF network based generator, and
<code>"indAttr"</code> assumes independent attributes and generates values 
for each attribute independently.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>noAvgBins</code></td>
<td>
<p>For IME method the number of discretization bins used to present model level explanations
and average explanations.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>displayAttributes</code></td>
<td>
<p> The vector of attribute names which are visualized, subject to <code>displayThreshold</code>) and value <code>modelVisCompact</code>.
The default value <code>displayThreshold=NULL</code> displays all attributes and their values.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>modelVisCompact</code></td>
<td>
<p> The logical value controlling if attribute values are displayed
in model level visualization. The default value <code>modelVisCompact=FALSE</code> displays all values of
attributes (subject to <code>displayThreshold</code>), and value <code>modelVisCompact=TRUE</code>
displays only contributions on the level of attributes (without their values).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>displayThreshold</code></td>
<td>
<p> The threshold value for absolute values of explanations 
below which feature contributions are not displayed in instance and model explanation graphs. 
The threshold applies after the values are normalized, see the explanation for parameter <code>normalizeTo</code>.
The default value <code>displayThreshold=0</code> displays contributions of all attributes.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>normalizeTo</code></td>
<td>
<p> For instance level visualization the absolute values of feature contributions are 
summed and normalized to the value of <code>normalizeTo</code>.
In model level explanation the normalization depends  on parameter <code>modelVisCompact</code>. If its value is <code>TRUE</code>,
the absolute values of all feature explanations are summed up and normalized to <code>normalizeTo</code>, otherwise
the absolute values of all feature values' contributions are summed up.
The value of <code>normalizeTo</code> common in some areas ( e.g., in medicine) is 100. The default value 0 implies no normalization.
The <code>displayThreshold</code> parameter refers to already normalized values.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>colors</code></td>
<td>
<p>A vector with 6 colors names, giving 6 colors used in visualization (average positive impact of attribute, average negative impact of attribute, 
positive instance explanation, negative instance explanation, average positive impact of attribute value, average negative impact of attribute value).
If set to NULL sensible grayscale defaults are used i.e., (gray30,gray30,gray60,gray60,gray90,gray90). </p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>noDecimalsInValueName</code></td>
<td>
<p>How many decimal places will numeric feature values use in visualizations.The default value is 2.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>modelTitle</code></td>
<td>
<p>A character string for title template of model visualization. See the details. If <code>modelTitle=NULL</code> the title is not shown. </p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>modelSubtitle</code></td>
<td>
<p>A character string for subtitle template of model visualization. See the details. If <code>modelSubtitle=NULL</code> the subtitle is not shown. </p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>instanceTitle</code></td>
<td>
<p>A character string for title template of instance visualization. See the details. If <code>instanceTitle=NULL</code> the title is not shown. </p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>instanceSubtitle</code></td>
<td>
<p>A character string for subtitle template of instance visualization. See the details. If <code>instanceSubtitle=NULL</code> the subtitle is not shown. </p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>recall</code></td>
<td>
<p>If parameter is different from NULL, it shall contain the list invisibly returned by one of previous calls to function <code>explainVis</code>. In this case the function reuses already computed explanations,
average explanations, discretization, etc.,  and only display data differently according to other supplied parameters. 
In this case values of parameters <code>model</code>, <code>testData</code> and <code>classValue</code>should be identical to the original call.
Values of parameters <code>trainData</code>, <code>method</code>, <code>naMode</code>, <code>explainType</code>, <code>nLaplace</code>, <code>estimator</code>,
<code>pError</code>, <code>err</code>, <code>batchSize</code>, <code>maxIter</code>, <code>genType</code>, and <code>noAvgBins</code>   are ignored.    
The parameters that do matter in this case are the ones that affect the display of already precomputed
results: <code>visLevel</code>,<code>dirName</code>, <code>fileType</code>, 
<code>displayAttributes</code>, <code>modelVisCompact</code>, <code>displayThreshold</code>, <code>normalizeTo</code>,
<code>colors</code>, <code>noDecimalsInValueName</code>, <code>modelTitle</code>, <code>modelSubtitle</code>, <code>instanceTitle</code>, and <code>instanceSubtitle</code>.

</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>The function <code>explainVis</code> generates explanations and their visualizations given the trained model, 
its training data, and data for which we want explanations. This is the frontend explanation function which takes
care of everything, internally calling other functions.
The produced visualizations are output to a graphical device or saved to a file. 
If one requires internal information about the explanations, they are returned invisibly. 
Separate calls to internal functions (<code>explain</code>, <code>ime</code>, 
<code>prepareForExplanations</code>, and <code>explanationAverages</code>) are also possible.
</p>
<p>In the model explanation all feature values  of nominal attributes and intervals of numeric attributes are visualized, as
well as weighted summary over all these values. 
In the instance level visualizations the contributions of each feature are presented (thick bars) as well as average contributions of these
feature values in the <code>trainData</code> (thin bars above them). For details see the references below.
</p>
<p>The titles and subtitles of model and instance explanation graphs use templates which allows insertion of the following values:
</p>

<ul>
<li>
<p> 	Response variable: %R
</p>
</li>
<li>
<p> Selected class value for explanation (in case of classification): %V 
</p>
</li>
<li>
<p> Type of model: %M
</p>
</li>
<li>
<p> Explanation method (see parameter <code>method</code>):: %E
</p>
</li>
<li>
<p> Explanation type (only for method EXPLAIN): %X
</p>
</li>
</ul>
<p>Title and subtitle of instance explanation graphs can additionally use the following information:
</p>

<ul>
<li>
<p> Instance name (extracted from <code>row.names</code> in <code>testData</code>): %I
</p>
</li>
<li>
<p> Predicted value/probability of the response: %P 
</p>
</li>
<li>
<p> True (class) value of the response: %T
</p>
</li>
</ul>
<p>Default templates for regression and classification models are provided. For example, the default template for title of model explanation is
"Explaining %R=%V\nmodel: %M", meaning that information about response variable, selected class value, and model are displayed in the title. 
</p>


<h3>Value</h3>

<p>The function <code>explainVis</code> generates explanations and saves their visualizations to a file or 
outputs them to graphical device,  based on the value of <code>fileType</code>. It invisibly returns a list with three components containing
explanations, average explanations, and additional data like discretization used and data generator.
The main ingredients of these three components are:
</p>

<ul>
<li> <p><code>expl</code>, a matrix of generated explanations  (of size <code>dim(testData)</code>), 
</p>
</li>
<li> <p><code>pCXA</code>, a vector of predictions,
</p>
</li>
<li> <p><code>stddev</code>, (for method IME only) a matrix with standard deviations of explanations,
</p>
</li>
<li> <p><code>noIter</code>, (for method IME only) a matrix with number of iterations executed for each explanation,
</p>
</li>
<li>  <p><code>discPoints</code>, (for method EXPLAIN only) a list containing values of discrete features 
or centers of discretization intervals for numeric features,
</p>
</li>
<li> <p><code>pAV</code>, (for method EXPLAIN only) a list with probabilities for discrete values or 
discretization intervals in case of numeric features,
</p>
</li>
<li> <p><code>discretization</code>, a list with discretization intervals output by <code>discretize</code> function,
used in estimating averages and model based explanations,
</p>
</li>
<li> <p><code>avNames</code>, a list containing the names of discrete values/intervals,
</p>
</li>
<li> <p><code>generator</code>, (for IME method only) a generator used to generate random part of instances in IME method,
</p>
</li>
<li> <p><code>explAvg</code>, a list with several components giving average explanations on the <code>trainingData</code>.
Averages are given for 
attributes, their values (for discrete attributes) and discretization intervals (for numeric features). 
These average explanations are used in visualization to give impression how the model works on average. This can be contrasted 
with explanation for the specific instance.
</p>
</li>
</ul>
<h3>Author(s)</h3>

<p> Marko Robnik-Sikonja </p>


<h3>References</h3>

<p>Marko Robnik-Sikonja, Igor Kononenko: Explaining Classifications For Individual Instances.
<em>IEEE Transactions on Knowledge and Data Engineering</em>, 20:589-600, 2008
</p>
<p>Erik Strumbelj, Igor Kononenko, Igor, Marko Robnik-Sikonja: Explaining Instance Classifications with Interactions of 
Subsets of Feature Values. <em>Data and Knowledge Engineering</em>, 68(10):886-904, Oct. 2009
</p>
<p>Erik Strumbelj, Igor Kononenko:  An Efficient Explanation of Individual Classifications using Game Theory, 
<em>Journal of Machine Learning Research</em>, 11(1):1-18, 2010. 
</p>
<p>Marko Robnik-Sikonja, Igor Kononenko: Discretization of continuous attributes using ReliefF.
<em>Proceedings of ERK'95</em>, B149-152, Ljubljana, 1995
</p>
<p>Some references are available from <a href="http://lkm.fri.uni-lj.si/rmarko/papers/">http://lkm.fri.uni-lj.si/rmarko/papers/</a>
</p>


<h3>See Also</h3>

<p><code>CORElearn</code>,
<code>predict.CoreModel</code>,
<code>attrEval</code>,
<code>discretize</code>,
<code>semiArtificial-package</code>
</p>


<h3>Examples</h3>

<pre><code class="language-R">require(CORElearn)
# use iris data set, split it randomly into a training and testing set
trainIdxs &lt;- sample(x=nrow(iris), size=0.7*nrow(iris), replace=FALSE)
testIdxs &lt;- c(1:nrow(iris))[-trainIdxs]
# build random forests model with certain parameters
modelRF &lt;- CoreModel(Species ~ ., iris[trainIdxs,], model="rf",
              selectionEstimator="MDL",minNodeWeightRF=5,
              rfNoTrees=100, maxThreads=1)

# generate model explanation and visualization
# turn on history in the visualization window to see all graphs
explainVis(modelRF, iris[trainIdxs,], iris[testIdxs,], method="EXPLAIN",visLevel="both",
           fileType="none", naMode="avg", explainType="WE", classValue=1) 
## Not run: 
#store instance explanations in grayscale to file in PDF format
explainVis(modelRF, iris[trainIdxs,], iris[testIdxs,], method="EXPLAIN", visLevel="instance",
           fileType="pdf", naMode="avg", explainType="WE", classValue=1, colors=NULL) 
destroyModels(modelRF) # clean up

# build a regression tree 
trainReg &lt;- regDataGen(100)
testReg &lt;- regDataGen(20)
modelRT &lt;- CoreModel(response~., trainReg, model="regTree", modelTypeReg=1)
# generate both model and instance level explanation using defaults
explainVis(modelRT, trainReg, testReg) 
destroyModels(modelRT) #clean up

## End(Not run)
</code></pre>


</div>