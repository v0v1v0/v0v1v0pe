<div class="container">

<table style="width: 100%;"><tr>
<td>epredict</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>
Estimability Enhancements for <code>lm</code> and Relatives
</h2>

<h3>Description</h3>

<p>These functions call the corresponding S3 <code>predict</code> methods in the <span class="pkg">stats</span> package, but with a check for estimability of new predictions, and with appropriate actions for non-estimable cases.
</p>


<h3>Usage</h3>

<pre><code class="language-R">## S3 method for class 'lm'
epredict(object, newdata, ..., 
    type = c("response", "terms", "matrix", "estimability"), 
    nonest.tol = 1e-8, nbasis = object$nonest)
## S3 method for class 'glm'
epredict(object, newdata, ..., 
    type = c("link", "response", "terms", "matrix", "estimability"), 
    nonest.tol = 1e-8, nbasis = object$nonest)
## S3 method for class 'mlm'
epredict(object, newdata, ..., 
    type = c("response", "matrix", "estimability"), 
    nonest.tol = 1e-8, nbasis = object$nonest)
    
eupdate(object, ...)    
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>object</code></td>
<td>
<p>An object inheriting from <code>lm</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>newdata</code></td>
<td>
<p>A <code>data.frame</code> containing predictor combinations for new predictions</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>...</code></td>
<td>
<p>Arguments passed to <code>predict</code> or <code>update</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>nonest.tol</code></td>
<td>
<p>Tolerance used by <code>is.estble</code> to check estimability of new predictions</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>type</code></td>
<td>
<p>Character string specifying the desired result. See Details.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>nbasis</code></td>
<td>
<p>Basis for the null space, e.g., a result of a call to <code>nonest.basis</code>. If <code>nbasis</code> is <code>NULL</code>, a basis is constructed from <code>object</code>.</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>If <code>newdata</code> is missing or <code>object</code> is not rank-deficient, this method passes its arguments directly to the same method in the <span class="pkg">stats</span> library. In rank-deficient cases with <code>newdata</code> provided, each row of <code>newdata</code> is tested for estimability against the null basis provided in <code>nbasis</code>. Any non-estimable cases found are replaced with <code>NA</code>s.
</p>
<p>The <code>type</code> argument is passed to <code>predict</code> when it is one of <code>"response"</code>, <code>"link"</code>, or <code>"terms"</code>. With <code>newdata</code> present and <code>type = "matrix"</code>, the model matrix for <code>newdata</code> is returned, with an attribute <code>"estble"</code> that is a logical vector of length ‘<span class="samp">⁠nrow(newdata)⁠</span>’ indicating whether each row is estimable. With <code>type = "estimability"</code>, just the logical vector is returned.
</p>
<p>If you anticipate making several <code>epredict</code> calls with new data, it improves efficiency to either obtain the null basis and provide it in the call, or add it to <code>object</code> with the name <code>"nonest"</code> (perhaps via a call to <code>eupdate</code>).
</p>
<p><code>eupdate</code> is an S3 generic function with a method provided for <code>"lm"</code> objects. It updates the object according to any arguments in <code>...</code>, then obtains the updated object's nonestimable basis and returns it in <code>object$nonest</code>.
</p>


<h3>Value</h3>

<p>The same as the result of a call to the <code>predict</code> method in the <span class="pkg">stats</span> package, except rows or elements corresponding to non-estimable predictor combinations are set to <code>NA</code>. The value for <code>type</code> is  <code>"matrix"</code> or <code>"estimability"</code> is explained under details.</p>


<h3>Note</h3>

<p>The capabilities of the <code>epredict</code> function for <code>lm</code> objects is provided 
by <code>predict.lm</code> (if using R version 4.3.0 or later) with <code>rankdeficient = "NA"</code>;
however, <code>epredict</code> 
uses <span class="pkg">estimability</span>'s own criteria to determine which predictions
are set to <code>NA</code>. An advantage of using <code>epredict</code> is one of
efficiency: we can compute the null basis once and for all and have it available
additional predictions, whereas <code>predict.lm</code> will re-compute it each time.
If the user wishes to see a message explaining why <code>NA</code>s were displayed,
set ‘<span class="samp">⁠options(estimability.verbose = TRUE)⁠</span>’.
</p>


<h3>Author(s)</h3>

<p>Russell V. Lenth &lt;russell-lenth@uiowa.edu&gt;
</p>


<h3>See Also</h3>

<p><code>predict.lm</code> in the <span class="pkg">stats</span> package;   
<code>nonest.basis</code>.
</p>


<h3>Examples</h3>

<pre><code class="language-R">require("estimability")

# Fake data where x3 and x4 depend on x1, x2, and intercept
x1 &lt;- -4:4
x2 &lt;- c(-2,1,-1,2,0,2,-1,1,-2)
x3 &lt;- 3*x1 - 2*x2
x4 &lt;- x2 - x1 + 4
y &lt;- 1 + x1 + x2 + x3 + x4 + c(-.5,.5,.5,-.5,0,.5,-.5,-.5,.5)

# Different orderings of predictors produce different solutions
mod1234 &lt;- lm(y ~ x1 + x2 + x3 + x4)
mod4321 &lt;- eupdate(lm(y ~ x4 + x3 + x2 + x1))
# (Estimability checking with mod4321 will be more efficient because
#  it will not need to recreate the basis)
mod4321$nonest

 
# test data:
testset &lt;- data.frame( 
              x1 = c(3,  6,  6,  0,  0,  1), 
              x2 = c(1,  2,  2,  0,  0,  2), 
              x3 = c(7, 14, 14,  0,  0,  3), 
              x4 = c(2,  4,  0,  4,  0,  4))

# Look at predictions when we don't check estimability
suppressWarnings( # Disable the warning from stats::predict.lm
    rbind(p1234 = predict(mod1234, newdata = testset),
          p4321 = predict(mod4321, newdata = testset)))

# Compare with results when we do check:
rbind(p1234 = epredict(mod1234, newdata = testset),
      p4321 = epredict(mod4321, newdata = testset))

# stats::predict has same capability for lm objects starting in version 4.3.0:
if((R.Version()$major &gt;= 4) &amp;&amp; (R.Version()$minor &gt;= 3))
  stats::predict(mod1234, newdata = testset, rankdeficient = "NA")

# Note that estimable cases have the same predictions

# change mod1234 and include nonest basis 
mod134 &lt;- eupdate(mod1234, . ~ . - x2, subset = -c(3, 7))
mod134$nonest

# When row spaces are the same, bases are interchangeable
# so long as you account for the ordering of parameters:
epredict(mod4321, newdata = testset, type = "estimability",
    nbasis = nonest.basis(mod1234)[c(1,5:2), ])
    
# Comparison with predict.lm in R &gt;= 4.3.0
if((R.Version()$major &gt;= 4) &amp;&amp; (R.Version()$minor &gt;= 3))
  stats::predict(mod4321, newdata = testset, rankdeficient = "NA")

## Not run: 
### Additional illustration
example(nonest.basis)  ## creates model objects warp.lm1 and warp.lm2

# The two models have different contrast specs. But the empty cell
# is correctly identified in both:
fac.cmb &lt;- expand.grid(wool = c("A", "B"), tension = c("L", "M", "H"))
cbind(fac.cmb, 
      pred1 = epredict(warp.lm1, newdata = fac.cmb), 
      pred2 = epredict(warp.lm2, newdata = fac.cmb))

## End(Not run) 

</code></pre>


</div>