<div class="container">

<table style="width: 100%;"><tr>
<td>fmgamma</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>MLE Fitting of Mixture of Gammas Using EM Algorithm</h2>

<h3>Description</h3>

<p>Maximum likelihood estimation for fitting the mixture of gammas distribution
using the EM algorithm.
</p>


<h3>Usage</h3>

<pre><code class="language-R">fmgamma(x, M, pvector = NULL, std.err = TRUE, method = "BFGS",
  control = list(maxit = 10000), finitelik = TRUE, ...)

lmgamma(x, mgshape, mgscale, mgweight, log = TRUE)

nlmgamma(pvector, x, M, finitelik = FALSE)

nlEMmgamma(pvector, tau, mgweight, x, M, finitelik = FALSE)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>x</code></td>
<td>
<p>vector of sample data</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>M</code></td>
<td>
<p>number of gamma components in mixture</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>pvector</code></td>
<td>
<p>vector of initial values of GPD parameters (<code>sigmau</code>, <code>xi</code>) or <code>NULL</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>std.err</code></td>
<td>
<p>logical, should standard errors be calculated</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>method</code></td>
<td>
<p>optimisation method (see <code>optim</code>)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>control</code></td>
<td>
<p>optimisation control list (see <code>optim</code>)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>finitelik</code></td>
<td>
<p>logical, should log-likelihood return finite value for invalid parameters</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>...</code></td>
<td>
<p>optional inputs passed to <code>optim</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>mgshape</code></td>
<td>
<p>mgamma shape (positive) as vector of length <code>M</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>mgscale</code></td>
<td>
<p>mgamma scale (positive) as vector of length <code>M</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>mgweight</code></td>
<td>
<p>mgamma weights (positive) as vector of length <code>M</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>log</code></td>
<td>
<p>logical, if <code>TRUE</code> then log-likelihood rather than likelihood is output</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>tau</code></td>
<td>
<p>matrix of posterior probability of being in each component
(<code>nxM</code> where <code>n</code> is <code>length(x)</code>)</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>The weighted mixture of gammas distribution is fitted to the entire
dataset by maximum likelihood estimation using the EM algorithm. The estimated parameters,
variance-covariance matrix and their standard errors are automatically output.
</p>
<p>The expectation step estimates the expected probability of being in each component
conditional on gamma component parameters. The maximisation step optimizes the
negative log-likelihood conditional on posterior probabilities of each observation
being in each component.
</p>
<p>The optimisation of the likelihood for these mixture models can be very sensitive to
the initial parameter vector, as often there are numerous local modes. This is an
inherent feature of such models and the EM algorithm. The EM algorithm is guaranteed
to reach the maximum of the local mode. Multiple initial values should be considered
to find the global maximum. If the <code>pvector</code> is input as <code>NULL</code> then 
random component probabilities are simulated as the initial values, so multiple such runs
should be run to check the sensitivity to initial values. Alternatives to black-box
likelihood optimisers (e.g. simulated annealing), or moving to computational Bayesian
inference, are also worth considering.
</p>
<p>The log-likelihood functions are provided for wider usage, e.g. constructing profile
likelihood functions. The parameter vector <code>pvector</code> must be specified in the
negative log-likelihood functions <code>nlmgamma</code> and
<code>nlEMmgamma</code>.
</p>
<p>Log-likelihood calculations are carried out in <code>lmgamma</code>,
which takes parameters as inputs in the same form as the distribution functions. The
negative log-likelihood function <code>nlmgamma</code> is a wrapper
for <code>lmgamma</code> designed towards making it useable for optimisation,
i.e. <code>nlmgamma</code> has complete parameter vector as first input.
Similarly, for the maximisation step negative log-likelihood
<code>nlEMmgamma</code>, which also has the second input as the component
probability vector <code>mgweight</code>.
</p>
<p>Missing values (<code>NA</code> and <code>NaN</code>) are assumed to be invalid data so are ignored.
</p>
<p>The function <code>lnormgpd</code> carries out the calculations
for the log-likelihood directly, which can be exponentiated to give actual
likelihood using (<code>log=FALSE</code>).
</p>
<p>The default optimisation algorithm in the "maximisation step" is "BFGS", which
requires a finite negative 
log-likelihood function evaluation <code>finitelik=TRUE</code>. For invalid 
parameters, a zero likelihood is replaced with <code>exp(-1e6)</code>. The "BFGS" 
optimisation algorithms require finite values for likelihood, so any user 
input for <code>finitelik</code> will be overridden and set to <code>finitelik=TRUE</code> 
if either of these optimisation methods is chosen.
</p>
<p>It will display a warning for non-zero convergence result comes from 
<code>optim</code> function call or for common indicators of lack
of convergence (e.g. any estimated parameters same as initial values).
</p>
<p>If the hessian is of reduced rank then the variance covariance (from inverse hessian)
and standard error of parameters cannot be calculated, then by default 
<code>std.err=TRUE</code> and the function will stop. If you want the parameter estimates
even if the hessian is of reduced rank (e.g. in a simulation study) then
set <code>std.err=FALSE</code>. 
</p>
<p>Suppose there are <code class="reqn">M</code> gamma components with (scalar) shape and scale parameters and
weight for each component. Only <code class="reqn">M-1</code> are to be provided in the initial parameter
vector, as the <code class="reqn">M</code>th components weight is uniquely determined from the others.
</p>
<p>For the fitting function <code>fmgamma</code> and negative log-likelihood
functions the parameter vector <code>pvector</code> is a <code>3*M-1</code> length vector
containing all <code class="reqn">M</code> gamma component shape parameters first, 
followed by the corresponding <code class="reqn">M</code> gamma scale parameters,
then all the corresponding <code class="reqn">M-1</code> probability weight parameters. The full parameter vector
is then <code>c(mgshape, mgscale, mgweight[1:(M-1)])</code>.
</p>
<p>For the maximisation step negative log-likelihood functions the parameter vector
<code>pvector</code> is a <code>2*M</code> length vector containing all <code class="reqn">M</code> gamma component
shape parameters first followed by the corresponding <code class="reqn">M</code> gamma scale parameters. The
partial parameter vector is then <code>c(mgshape, mgscale)</code>.
</p>
<p>For identifiability purposes the mean of each gamma component must be in ascending in order. 
If the initial parameter vector does not satisfy this constraint then an error is given. 
</p>
<p>Non-positive data are ignored as likelihood is infinite, except for <code>gshape=1</code>.
</p>


<h3>Value</h3>

<p>Log-likelihood is given by <code>lmgamma</code> and it's
wrapper for negative log-likelihood from <code>nlmgamma</code>. 
The conditional negative log-likelihood
using the posterior probabilities is given by <code>nlEMmgamma</code>.
Fitting function <code>fmgammagpd</code> using EM algorithm returns
a simple list with the following elements
</p>

<table>
<tr>
<td style="text-align: left;">
 <code>call</code>:      </td>
<td style="text-align: left;"> <code>optim</code> call</td>
</tr>
<tr>
<td style="text-align: left;">
 <code>x</code>:         </td>
<td style="text-align: left;"> data vector <code>x</code>
</td>
</tr>
<tr>
<td style="text-align: left;">
 <code>init</code>:      </td>
<td style="text-align: left;"> <code>pvector</code>
</td>
</tr>
<tr>
<td style="text-align: left;">
 <code>optim</code>:     </td>
<td style="text-align: left;"> complete <code>optim</code> output</td>
</tr>
<tr>
<td style="text-align: left;">
 <code>mle</code>:       </td>
<td style="text-align: left;"> vector of MLE of parameters</td>
</tr>
<tr>
<td style="text-align: left;">
 <code>cov</code>:       </td>
<td style="text-align: left;"> variance-covariance matrix of MLE of parameters</td>
</tr>
<tr>
<td style="text-align: left;">
 <code>se</code>:        </td>
<td style="text-align: left;"> vector of standard errors of MLE of parameters</td>
</tr>
<tr>
<td style="text-align: left;">
 <code>nllh</code>:      </td>
<td style="text-align: left;"> minimum negative log-likelihood</td>
</tr>
<tr>
<td style="text-align: left;">
 <code>n</code>:         </td>
<td style="text-align: left;"> total sample size</td>
</tr>
<tr>
<td style="text-align: left;">
 <code>M</code>:         </td>
<td style="text-align: left;"> number of gamma components</td>
</tr>
<tr>
<td style="text-align: left;">
 <code>mgshape</code>:   </td>
<td style="text-align: left;"> MLE of gamma shapes</td>
</tr>
<tr>
<td style="text-align: left;">
 <code>mgscale</code>:   </td>
<td style="text-align: left;"> MLE of gamma scales</td>
</tr>
<tr>
<td style="text-align: left;">
 <code>mgweight</code>:  </td>
<td style="text-align: left;"> MLE of gamma weights</td>
</tr>
<tr>
<td style="text-align: left;">
 <code>EMresults</code>: </td>
<td style="text-align: left;"> EM results giving complete negative log-likelihood, estimated parameters
                        and conditional "maximisation step" negative log-likelihood and convergence result</td>
</tr>
<tr>
<td style="text-align: left;">
 <code>posterior</code>: </td>
<td style="text-align: left;"> posterior probabilites</td>
</tr>
<tr>
<td style="text-align: left;">
</td>
</tr>
</table>
<h3>Acknowledgments</h3>

<p>Thanks to Daniela Laas, University of St Gallen, Switzerland for reporting various bugs in these functions.
</p>


<h3>Note</h3>

<p>In the fitting and profile likelihood functions, when <code>pvector=NULL</code> then the default initial values
are obtained under the following scheme:
</p>

<ul>
<li>
<p> number of sample from each component is simulated from symmetric multinomial distribution;
</p>
</li>
<li>
<p> sample data is then sorted and split into groups of this size (works well when components
have modes which are well separated);
</p>
</li>
<li>
<p> for data within each component approximate MLE's for the
gamma shape and scale parameters are estimated.
</p>
</li>
</ul>
<p>The <code>lmgamma</code>, <code>nlmgamma</code> and
<code>nlEMmgamma</code> have no defaults.
</p>
<p>If the hessian is of reduced rank then the variance covariance (from inverse hessian)
and standard error of parameters cannot be calculated, then by default 
<code>std.err=TRUE</code> and the function will stop. If you want the parameter estimates
even if the hessian is of reduced rank (e.g. in a simulation study) then
set <code>std.err=FALSE</code>. 
</p>
<p>Invalid parameter ranges will give <code>0</code> for likelihood, <code>log(0)=-Inf</code> for
log-likelihood and <code>-log(0)=Inf</code> for negative log-likelihood. 
</p>
<p>Infinite and missing sample values are dropped.
</p>
<p>Error checking of the inputs is carried out and will either stop or give warning message
as appropriate.
</p>


<h3>Author(s)</h3>

<p>Carl Scarrott <a href="mailto:carl.scarrott@canterbury.ac.nz">carl.scarrott@canterbury.ac.nz</a>
</p>


<h3>References</h3>

<p><a href="http://www.math.canterbury.ac.nz/~c.scarrott/evmix">http://www.math.canterbury.ac.nz/~c.scarrott/evmix</a>
</p>
<p><a href="http://en.wikipedia.org/wiki/Gamma_distribution">http://en.wikipedia.org/wiki/Gamma_distribution</a>
</p>
<p><a href="http://en.wikipedia.org/wiki/Mixture_model">http://en.wikipedia.org/wiki/Mixture_model</a>
</p>
<p>McLachlan, G.J. and Peel, D. (2000). Finite Mixture Models. Wiley.
</p>


<h3>See Also</h3>

<p><code>dgamma</code> and <code>gammamixEM</code>
in <code>mixtools</code> package
</p>
<p>Other gammagpd: <code>fgammagpdcon</code>,
<code>fgammagpd</code>, <code>fmgammagpd</code>,
<code>gammagpdcon</code>, <code>gammagpd</code>,
<code>mgammagpd</code>
</p>
<p>Other mgamma: <code>fmgammagpdcon</code>,
<code>fmgammagpd</code>, <code>mgammagpdcon</code>,
<code>mgammagpd</code>, <code>mgamma</code>
</p>
<p>Other mgammagpd: <code>fgammagpd</code>,
<code>fmgammagpdcon</code>, <code>fmgammagpd</code>,
<code>gammagpd</code>, <code>mgammagpdcon</code>,
<code>mgammagpd</code>, <code>mgamma</code>
</p>
<p>Other mgammagpdcon: <code>fgammagpdcon</code>,
<code>fmgammagpdcon</code>, <code>fmgammagpd</code>,
<code>gammagpdcon</code>, <code>mgammagpdcon</code>,
<code>mgammagpd</code>, <code>mgamma</code>
</p>
<p>Other fmgamma: <code>mgamma</code>
</p>


<h3>Examples</h3>

<pre><code class="language-R">## Not run: 
set.seed(1)
par(mfrow = c(1, 1))

x = c(rgamma(1000, shape = 1, scale = 1), rgamma(3000, shape = 6, scale = 2))
xx = seq(-1, 40, 0.01)
y = (dgamma(xx, shape = 1, scale = 1) + 3 * dgamma(xx, shape = 6, scale = 2))/4

# Fit by EM algorithm
fit = fmgamma(x, M = 2)
hist(x, breaks = 100, freq = FALSE, xlim = c(-1, 40))
lines(xx, y)
with(fit, lines(xx, dmgamma(xx, mgshape, mgscale, mgweight), col="red"))

## End(Not run)

</code></pre>


</div>