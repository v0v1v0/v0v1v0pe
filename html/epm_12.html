<div class="container">

<table style="width: 100%;"><tr>
<td>customGridMetric</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Custom grid metrics</h2>

<h3>Description</h3>

<p>Define your own function for summarizing information across grid
cells.
</p>


<h3>Usage</h3>

<pre><code class="language-R">customGridMetric(
  x,
  fun,
  column = NULL,
  minTaxCount = 1,
  metricName = "custom_metric"
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>x</code></td>
<td>
<p>object of class <code>epmGrid</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>fun</code></td>
<td>
<p>a function to apply to all grid cells (see details)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>column</code></td>
<td>
<p>If a univariate morphological metric is specified, and the data
in <code>x</code> are multivariate, which trait should be used? This can also
specify which subset of columns a multivariate metric should be applied to.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>minTaxCount</code></td>
<td>
<p>the minimum number of taxa needed to apply the function.
For instance, should the function be applied to gridcells with just 1
taxon?</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>metricName</code></td>
<td>
<p>the name you would like to attach to the output</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>This function allows you to not be limited to the diversity metrics
available via the <code>gridMetrics</code> function. <br></p>
<p>The custom function should have just one input: a vector of taxon names
that will then be used to subset the trait or phylogenetic data. Within the
function call, the trait data already attached to the epmGrid object must
be referred to as dat, and the phylogenetic tree already attached to the
epmGrid must be referred to as phylo.<br></p>
<p>If the input epmGrid object contains a set of trees, then this function will
be applied, using each tree in turn, and will return a list of results. This
list can then be passed to <code>summarizeEpmGridList</code> to be summarized.
</p>
<p>See examples below.
</p>


<h3>Value</h3>

<p>object of class <code>epmGrid</code>, or list of <code>epmGrid</code> objects
</p>


<h3>Author(s)</h3>

<p>Pascal Title
</p>


<h3>Examples</h3>

<pre><code class="language-R">tamiasEPM
tamiasEPM &lt;- addPhylo(tamiasEPM, tamiasTree)
tamiasEPM &lt;- addTraits(tamiasEPM, tamiasTraits)

# In the following examples, notice that any mention of the trait data or 
## phylogeny that are already attached to the epmGrid object are referred 
## to as dat and phylo.

# example: calculate morphological disparity 
## (already implemented in gridMetrics)
f &lt;- function(cells) {
	sum(diag(cov(dat[cells,])))
}

# to calculate disparity, we need at least 2 taxa

xx &lt;- customGridMetric(tamiasEPM, fun = f, minTaxCount = 2, 
metricName = 'disparity')

# In the example above, gridcells with 1 species are left as NA. 
## But if we wanted those gridcells to have a value of 0 rather than NA, 
## we could do the following:
f &lt;- function(sp) {
	if (length(sp) == 1) {
		0
	} else {
		sum(diag(cov(dat[sp,])))
	}
}

# and change minTaxCount to 1
xx &lt;- customGridMetric(tamiasEPM, fun = f, minTaxCount = 1, 
metricName = 'disparity')


# phylogenetic example: mean patristic distance
## this example doesn't actually involve the phylogeny internally,
## we can just supply what is needed to the function
patdist &lt;- cophenetic(tamiasEPM[['phylo']])
patdist[upper.tri(patdist, diag = TRUE)] &lt;- NA
f &lt;- function(cells) {
	mean(patdist[cells, cells], na.rm = TRUE)
}

xx &lt;- customGridMetric(tamiasEPM, fun = f, minTaxCount = 1, 
metricName = 'mean patristic')

# an example that involves both morphological and phylogenetic data
## nonsensical, but for illustrative purposes:
## ratio of Faith's phylogenetic diversity to morphological range
f &lt;- function(cells) {
	faithPD(phylo, cells) / max(dist(dat[cells, ]))
}

xx &lt;- customGridMetric(tamiasEPM, fun = f, minTaxCount = 2, 
metricName = 'PD_range_ratio')


# Example involving a set of trees
tamiasEPM &lt;- addPhylo(tamiasEPM, tamiasTreeSet, replace = TRUE)

# get crown clade age of clade containing taxa present in grid cell
f &lt;- function(sp) {
	ape::branching.times(phylo)[as.character(ape::getMRCA(phylo, sp))]
}

xx &lt;- customGridMetric(tamiasEPM, fun = f, minTaxCount = 2, metric = 'nodeAge')



</code></pre>


</div>